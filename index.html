<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Verified Buy & Sell</title>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- CSS Variables for Theming -->
    <style>
        :root {
            --color-primary: 19, 171, 236;
            /* Default Blue #13abec */
        }
    </style>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "rgb(var(--color-primary))",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101c22",
                        "success-green": "#22c55e",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow: hidden;
        }

        .safe-area-top {
            padding-top: var(--tg-safe-area-inset-top, 0px);
        }

        .safe-area-bottom {
            padding-bottom: var(--tg-safe-area-inset-bottom, 0px);
        }

        main {
            height: calc(100dvh - 64px - 64px);
            /* Header + Nav */
            overflow-y: auto;
        }

        main::-webkit-scrollbar {
            display: none;
        }

        .ios-blur {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Theme Circle Active Check */
        .theme-circle.active {
            ring-width: 2px;
            ring-color: white;
            ring-offset-width: 2px;
            ring-offset-color: #101c22;
        }

        /* Chat Animations */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .chat-open {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-white transition-colors duration-300">
    <div id="app" class="relative flex h-screen w-full flex-col overflow-hidden">

        <!-- TopAppBar -->
        <header
            class="safe-area-top flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-50">
            <div class="flex size-12 shrink-0 items-center">
                <div id="user-avatar"
                    class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-primary/20"
                    style='background-image: url("https://ui-avatars.com/api/?name=User&background=13abec&color=fff");'>
                </div>
            </div>
            <h2 id="page-title"
                class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">
                Verified Buy & Sell</h2>
            <div class="flex w-12 items-center justify-end gap-2">
                <!-- Actions Removed -->
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-scroll" class="flex-1 pb-24">

            <!-- Balance Tab -->
            <div id="tab-balance" class="tab-content">
                <div class="flex flex-col items-center justify-center py-6">
                    <!-- Split Balance View -->
                    <div class="w-full px-4 grid grid-cols-2 gap-4">
                        <div
                            class="bg-white dark:bg-[#1a282f] p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm text-center">
                            <p
                                class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">
                                Available Balance</p>
                            <h2 class="text-slate-900 dark:text-white text-xl font-bold"><span id="bal-main">0.00</span>
                                <span class="text-primary text-sm">BDT</span>
                            </h2>
                        </div>
                        <div
                            class="bg-white dark:bg-[#1a282f] p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm text-center">
                            <p
                                class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">
                                Hold Balance</p>
                            <h2 class="text-slate-400 dark:text-slate-300 text-xl font-bold"><span
                                    id="bal-hold">0.00</span> <span class="text-xs">BDT</span></h2>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mb-6">
                    <div class="flex flex-1 gap-4 px-4 max-w-[480px] justify-center w-full">
                        <!-- Deposit Button -->
                        <button onclick="handleDeposit()"
                            class="flex flex-1 items-center justify-center gap-2 rounded-xl h-14 bg-success-green text-white text-base font-bold transition-transform active:scale-95 shadow-lg shadow-success-green/20">
                            <span class="material-symbols-outlined">add_circle</span>
                            <span class="truncate text-lg">Deposit</span>
                        </button>
                        <!-- Withdraw Button -->
                        <button onclick="handleWithdraw()"
                            class="flex flex-1 items-center justify-center gap-2 rounded-xl h-14 bg-slate-800 dark:bg-slate-700 text-white text-base font-bold transition-transform active:scale-95 shadow-lg shadow-black/20">
                            <span class="material-symbols-outlined">payments</span>
                            <span class="truncate text-lg">Withdraw</span>
                        </button>
                    </div>
                </div>

                <div class="px-4 mb-8">
                    <div onclick="switchTab('p2p')"
                        class="bg-primary/10 border border-primary/20 rounded-xl p-4 flex items-center justify-between cursor-pointer active:opacity-80">
                        <div class="flex items-center gap-3">
                            <div class="bg-primary/20 p-2 rounded-lg text-primary">
                                <span class="material-symbols-outlined">currency_exchange</span>
                            </div>
                            <div>
                                <p class="text-slate-900 dark:text-white font-bold text-sm">P2P Marketplace</p>
                                <p class="text-slate-500 dark:text-slate-400 text-xs">Buy or sell crypto locally</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-primary">chevron_right</span>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-900/50 rounded-t-[32px] pt-2 shadow-2xl">
                    <div class="flex items-center justify-between px-6 pt-6 pb-4">
                        <h3 class="text-slate-900 dark:text-white text-xl font-bold tracking-[-0.015em]">Recent Activity
                        </h3>
                        <button class="text-primary text-sm font-semibold">See all</button>
                    </div>

                    <div id="recent-activity-list" class="space-y-1 px-4 pb-10">
                        <div class="flex flex-col items-center justify-center py-8 text-slate-400">
                            <span
                                class="material-symbols-outlined text-[32px] mb-2 opacity-50">history_toggle_off</span>
                            <p class="text-sm">No recent transactions</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P2P Tab -->
            <div id="tab-p2p" class="tab-content hidden">
                <div class="sticky top-0 z-40 bg-background-light dark:bg-background-dark/95 backdrop-blur-md">
                    <div class="px-4 py-2">
                        <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                            <button onclick="toggleP2PType('buy')" id="btn-p2p-buy"
                                class="flex-1 py-2 text-sm font-bold rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm transition-all">Buy</button>
                            <button onclick="toggleP2PType('sell')" id="btn-p2p-sell"
                                class="flex-1 py-2 text-sm font-bold text-slate-500 dark:text-slate-400 transition-all">Sell</button>
                        </div>
                    </div>
                    <div class="flex gap-2 px-4 py-3 overflow-x-auto no-scrollbar">
                        <button
                            class="flex h-9 shrink-0 items-center justify-center gap-x-1 rounded-full bg-primary/10 border border-primary/20 px-4">
                            <p class="text-primary text-xs font-semibold">BDT/USD</p>
                            <span class="material-symbols-outlined text-primary text-[16px]">expand_more</span>
                        </button>
                    </div>
                </div>

                <div id="p2p-list" class="px-4 space-y-3 pb-10">
                    <!-- Dynamic Ads Injected Here -->
                </div>
            </div>

            <!-- Referral Tab -->
            <div id="tab-referral" class="tab-content hidden">
                <div class="flex flex-col pb-24">
                    <div class="px-4 py-4">
                        <div class="bg-cover bg-center flex flex-col justify-end overflow-hidden rounded-xl min-h-[200px] shadow-lg relative"
                            style='background-image: linear-gradient(180deg, rgba(var(--color-primary), 0.2) 0%, rgba(16, 28, 34, 0.9) 100%), url("https://images.unsplash.com/photo-1639762681485-074b7f938ba0?auto=format&fit=crop&w=800&q=80");'>
                            <div class="flex flex-col p-6 space-y-2">
                                <span
                                    class="bg-primary text-white text-[10px] font-extrabold uppercase tracking-widest px-2 py-1 rounded w-fit">Limited
                                    Offer</span>
                                <p class="text-white tracking-tight text-2xl font-bold leading-tight">Get 1% Lifetime
                                    commission from your friends' trades</p>
                            </div>
                        </div>
                    </div>
                    <div class="px-4 py-2">
                        <div
                            class="bg-white dark:bg-[#1a282f] p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm mb-4 text-center">
                            <h3
                                class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">
                                Total Referred Users
                            </h3>
                            <h2 class="text-3xl font-bold text-slate-900 dark:text-white" id="ref-tab-count">0 Users
                            </h2>
                        </div>

                        <div
                            class="bg-primary/10 dark:bg-primary/5 border border-primary/20 rounded-xl p-4 flex flex-col gap-3">
                            <div class="flex items-center justify-between">
                                <h3
                                    class="text-slate-900 dark:text-white text-[10px] font-bold uppercase tracking-wider">
                                    Your Referral Link</h3>
                            </div>
                            <div
                                class="flex items-center gap-2 bg-white dark:bg-background-dark border border-slate-200 dark:border-slate-700 rounded-lg p-3">
                                <span id="ref-link"
                                    class="text-slate-600 dark:text-slate-400 text-xs truncate flex-1 font-mono">t.me/WalletBot?start=ref_12345</span>
                                <button onclick="copyRefLink()"
                                    class="flex items-center justify-center text-primary hover:bg-primary/10 p-1 rounded transition-colors">
                                    <span class="material-symbols-outlined text-[20px]">content_copy</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="px-4 mt-8">
                        <button onclick="inviteFriends()"
                            class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-primary/20 transition-all active:scale-[0.98]">
                            <span class="material-symbols-outlined">send</span>
                            Invite Friends
                        </button>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="tab-leaderboard" class="tab-content hidden">
                <div class="px-4 py-6">
                    <div
                        class="bg-gradient-to-br from-yellow-500 to-orange-600 rounded-2xl p-6 text-white shadow-lg mb-8 relative overflow-hidden">
                        <div class="relative z-10 flex flex-col items-center">
                            <span class="material-symbols-outlined text-[64px] mb-2">emoji_events</span>
                            <h2 class="text-2xl font-black italic tracking-wider">TOP TRADERS</h2>
                            <p class="text-white/80 text-xs font-medium uppercase tracking-widest mt-1">Real-time
                                Ranking</p>
                        </div>
                        <div class="absolute -right-8 -bottom-8 text-white/10 rotate-12">
                            <span class="material-symbols-outlined text-[160px]">leaderboard</span>
                        </div>
                    </div>

                    <div id="leaderboard-list" class="space-y-3 pb-24">
                        <!-- Users sorted by balance will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="tab-profile" class="tab-content hidden">
                <div class="pb-12">
                    <!-- Profile Header -->
                    <div class="flex flex-col items-center py-6 px-4">
                        <div class="relative">
                            <div id="profile-pic-large"
                                class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-28 w-28 border-4 border-primary/20"
                                style='background-image: url("https://ui-avatars.com/api/?name=User&background=13abec&color=fff");'>
                            </div>
                            <div
                                class="absolute bottom-1 right-1 bg-primary text-white rounded-full p-1 border-2 border-background-dark flex items-center justify-center">
                                <span class="material-symbols-outlined text-[16px] font-bold">verified</span>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <h1 id="profile-name"
                                class="text-slate-900 dark:text-white text-2xl font-bold tracking-tight">User Name</h1>
                            <p id="profile-username" class="text-slate-500 dark:text-slate-400 text-sm font-medium">
                                @username</p>
                            <div class="mt-2 inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full bg-primary/10 text-primary text-xs font-semibold hidden"
                                id="profile-badge-verified">
                                <span class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></span>
                                Verified User
                            </div>
                            <button onclick="openNIDModal()" id="profile-btn-verify"
                                class="mt-2 hidden inline-flex items-center gap-1 px-4 py-1.5 rounded-full bg-primary text-white text-xs font-bold shadow-lg shadow-primary/20 hover:scale-105 transition-transform">
                                <span class="material-symbols-outlined text-[16px]">verified_user</span>
                                Verify NID Now
                            </button>
                            <div class="mt-2 inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full bg-yellow-500/10 text-yellow-500 text-xs font-semibold hidden"
                                id="profile-badge-pending">
                                <span class="material-symbols-outlined text-[14px]">pending</span>
                                Verification Pending
                            </div>

                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="flex gap-3 px-4 mb-8">
                        <div
                            class="flex-1 flex flex-col gap-1 rounded-xl p-4 bg-white dark:bg-[#1a282f] shadow-sm border border-slate-200 dark:border-slate-800 text-slate-900 dark:text-white">
                            <p
                                class="text-slate-500 dark:text-slate-400 text-[10px] font-medium uppercase tracking-wider">
                                Total Balance</p>
                            <p class="text-xl font-bold leading-tight"><span id="profile-bal-total">0.00</span> BDT</p>
                        </div>
                        <div
                            class="flex-1 flex flex-col gap-1 rounded-xl p-4 bg-white dark:bg-[#1a282f] shadow-sm border border-slate-200 dark:border-slate-800 text-slate-900 dark:text-white">
                            <p
                                class="text-slate-500 dark:text-slate-400 text-[10px] font-medium uppercase tracking-wider mb-1">
                                Live P2P Users</p>
                            <h2 class="text-primary text-xl font-bold flex items-center justify-center gap-2">
                                <span class="relative flex h-3 w-3">
                                    <span
                                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                                </span>
                                <span id="live-user-count">0</span>
                            </h2>
                        </div>
                    </div>

                    <!-- Preferences -->
                    <div class="mb-6">
                        <h3
                            class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-widest px-6 mb-2">
                            Preferences</h3>
                        <div
                            class="mx-4 bg-white dark:bg-[#1a282f] rounded-xl overflow-hidden border border-slate-200 dark:border-slate-800 shadow-sm">
                            <div id="theme-menu-btn" onclick="toggleThemeMenu()"
                                class="flex items-center gap-4 px-4 py-3.5 active:bg-slate-50 dark:active:bg-white/5 cursor-pointer border-b border-slate-100 dark:border-slate-800/50 text-slate-900 dark:text-white">
                                <div
                                    class="flex items-center justify-center rounded-lg bg-pink-500/20 text-pink-500 shrink-0 size-10">
                                    <span class="material-symbols-outlined">palette</span>
                                </div>
                                <p class="text-sm font-medium flex-1">App Theme</p>
                                <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                            </div>

                            <div id="theme-selector-area"
                                class="hidden bg-slate-50 dark:bg-black/20 p-4 border-b border-slate-100 dark:border-slate-800/50">
                                <p class="text-xs text-slate-500 mb-3 ml-1">Select Accent Day</p>
                                <div class="flex gap-4 justify-around">
                                    <div onclick="setTheme('19, 171, 236')"
                                        class="cursor-pointer flex flex-col items-center gap-1">
                                        <div
                                            class="w-8 h-8 rounded-full bg-[#13abec] ring-2 ring-transparent transition-all">
                                        </div>
                                        <span class="text-[10px] text-slate-500">Blue</span>
                                    </div>
                                    <div onclick="setTheme('34, 197, 94')"
                                        class="cursor-pointer flex flex-col items-center gap-1">
                                        <div
                                            class="w-8 h-8 rounded-full bg-[#22c55e] ring-2 ring-transparent transition-all">
                                        </div>
                                        <span class="text-[10px] text-slate-500">Green</span>
                                    </div>
                                    <div onclick="setTheme('168, 85, 247')"
                                        class="cursor-pointer flex flex-col items-center gap-1">
                                        <div
                                            class="w-8 h-8 rounded-full bg-[#a855f7] ring-2 ring-transparent transition-all">
                                        </div>
                                        <span class="text-[10px] text-slate-500">Purple</span>
                                    </div>
                                    <div onclick="setTheme('249, 115, 22')"
                                        class="cursor-pointer flex flex-col items-center gap-1">
                                        <div
                                            class="w-8 h-8 rounded-full bg-[#f97316] ring-2 ring-transparent transition-all">
                                        </div>
                                        <span class="text-[10px] text-slate-500">Orange</span>
                                    </div>
                                </div>
                            </div>

                            <div onclick="switchTab('leaderboard')"
                                class="flex items-center gap-4 px-4 py-3.5 active:bg-slate-50 dark:active:bg-white/5 cursor-pointer border-b border-slate-100 dark:border-slate-800/50 text-slate-900 dark:text-white">
                                <div
                                    class="flex items-center justify-center rounded-lg bg-yellow-500/20 text-yellow-500 shrink-0 size-10">
                                    <span class="material-symbols-outlined">leaderboard</span>
                                </div>
                                <p class="text-sm font-medium flex-1">Leaderboard</p>
                                <span class="material-symbols-outlined text-slate-400">chevron_right</span>
                            </div>

                            <div onclick="toggleDarkMode()"
                                class="flex items-center gap-4 px-4 py-3.5 active:bg-slate-50 dark:active:bg-white/5 cursor-pointer text-slate-900 dark:text-white">
                                <div
                                    class="flex items-center justify-center rounded-lg bg-indigo-500/20 text-indigo-500 shrink-0 size-10">
                                    <span class="material-symbols-outlined">dark_mode</span>
                                </div>
                                <p class="text-sm font-medium flex-1">Dark Mode</p>
                                <div id="dark-mode-toggle"
                                    class="w-10 h-5 bg-slate-300 dark:bg-primary rounded-full relative shadow-inner transition-colors duration-300">
                                    <div
                                        class="absolute left-0.5 dark:left-auto dark:right-0.5 top-0.5 w-4 h-4 bg-white rounded-full shadow-md transition-all">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Logout -->
                    <div class="px-4 pb-8">
                        <button onclick="Telegram.WebApp.close()"
                            class="w-full flex items-center justify-center gap-2 py-4 rounded-xl bg-red-500/10 text-red-500 font-bold border border-red-500/20 active:bg-red-500/20 transition-colors">
                            <span class="material-symbols-outlined">logout</span>
                            Logout
                        </button>
                        <p class="text-center text-slate-500 text-[10px] mt-4 opacity-50 uppercase tracking-widest">App
                            Version 2.5.0</p>
                    </div>
                </div>
            </div>

        </main>

        <!-- Deposit Modal -->
        <div id="deposit-modal"
            class="fixed inset-0 z-[9999] hidden flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
            <div class="bg-white dark:bg-[#1a282f] w-full max-w-sm rounded-2xl p-6 shadow-xl animate-slide-up space-y-4 max-h-[90vh] overflow-y-auto transition-all duration-300"
                style="min-height: 400px">

                <!-- Header -->
                <div class="flex items-center justify-between">
                    <h3 id="dep-title" class="text-lg font-bold text-slate-900 dark:text-white">Select Method</h3>
                    <button onclick="closeDepositModal()"
                        class="text-slate-500 hover:text-slate-700 dark:hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- Step 1: Selection -->
                <div id="dep-step-1" class="space-y-4 animate-fade-in">
                    <p class="text-sm text-slate-500">Tap a payment method to copy the number and proceed.</p>

                    <div class="grid grid-cols-1 gap-3">
                        <!-- Binance -->
                        <div onclick="selectDepositMethod('binance', '763666850', 'Binance')"
                            class="p-4 bg-slate-50 dark:bg-black/20 rounded-xl border border-slate-100 dark:border-slate-800 flex items-center justify-between cursor-pointer hover:border-primary/50 transition-all active:scale-95 group">
                            <div class="flex items-center gap-4">
                                <div
                                    class="size-12 rounded-full bg-[#F3BA2F]/10 flex items-center justify-center text-[#F3BA2F]">
                                    <span class="material-symbols-outlined text-xl">currency_bitcoin</span>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-900 dark:text-white">Binance Pay</p>
                                    <p class="text-xs font-mono text-slate-500">763666850</p>
                                </div>
                            </div>
                            <span
                                class="material-symbols-outlined text-slate-400 group-hover:text-primary">arrow_forward_ios</span>
                        </div>

                        <!-- Bkash -->
                        <div onclick="selectDepositMethod('bkash', '01609434652', 'Bkash')"
                            class="p-4 bg-slate-50 dark:bg-black/20 rounded-xl border border-slate-100 dark:border-slate-800 flex items-center justify-between cursor-pointer hover:border-primary/50 transition-all active:scale-95 group">
                            <div class="flex items-center gap-4">
                                <div
                                    class="size-12 rounded-full bg-[#e2136e]/10 flex items-center justify-center text-[#e2136e]">
                                    <span class="material-symbols-outlined text-xl">payments</span>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-900 dark:text-white">Bkash Personal</p>
                                    <p class="text-xs font-mono text-slate-500">01609434652</p>
                                </div>
                            </div>
                            <span
                                class="material-symbols-outlined text-slate-400 group-hover:text-primary">arrow_forward_ios</span>
                        </div>

                        <!-- Nagad -->
                        <div onclick="selectDepositMethod('nagad', '01625199589', 'Nagad')"
                            class="p-4 bg-slate-50 dark:bg-black/20 rounded-xl border border-slate-100 dark:border-slate-800 flex items-center justify-between cursor-pointer hover:border-primary/50 transition-all active:scale-95 group">
                            <div class="flex items-center gap-4">
                                <div
                                    class="size-12 rounded-full bg-[#f7941d]/10 flex items-center justify-center text-[#f7941d]">
                                    <span class="material-symbols-outlined text-xl">account_balance_wallet</span>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-900 dark:text-white">Nagad Personal</p>
                                    <p class="text-xs font-mono text-slate-500">01625199589</p>
                                </div>
                            </div>
                            <span
                                class="material-symbols-outlined text-slate-400 group-hover:text-primary">arrow_forward_ios</span>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Form -->
                <div id="dep-step-2" class="hidden space-y-4 animate-fade-in">

                    <!-- Selected Summary -->
                    <div class="p-3 bg-primary/5 rounded-xl border border-primary/20 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div
                                class="size-8 rounded-full bg-primary/20 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined text-sm">check</span>
                            </div>
                            <div>
                                <p id="dep-selected-name" class="text-sm font-bold text-slate-900 dark:text-white">Bkash
                                </p>
                                <p id="dep-selected-number" class="text-xs font-mono text-slate-500">01...</p>
                            </div>
                        </div>
                        <button onclick="showStep1()"
                            class="text-xs font-bold text-primary hover:underline">Change</button>
                    </div>

                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-slate-500 mb-1 block">Amount (BDT)</label>
                                <input id="dep-amount" type="number" placeholder="10"
                                    class="w-full bg-slate-50 dark:bg-black/20 border-0 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:ring-1 focus:ring-primary font-bold">
                                <p id="dep-limit-text" class="text-[10px] text-slate-400 mt-1 text-right">Min: 10 BDT
                                </p>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 mb-1 block">Sender Number</label>
                                <input id="dep-number" type="text" placeholder="017..."
                                    class="w-full bg-slate-50 dark:bg-black/20 border-0 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:ring-1 focus:ring-primary">
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">Screenshot / Proof</label>
                            <div class="relative">
                                <input type="file" id="dep-photo" accept="image/*" class="hidden"
                                    onchange="previewFile()">
                                <div id="upload-box" onclick="document.getElementById('dep-photo').click()"
                                    class="w-full h-24 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl flex flex-col items-center justify-center text-slate-400 cursor-pointer hover:border-primary/50 transition relative overflow-hidden bg-slate-50 dark:bg-black/20">
                                    <span class="material-symbols-outlined text-2xl mb-1">add_a_photo</span>
                                    <span class="text-xs">Tap to upload screenshot</span>
                                    <img id="dep-preview"
                                        class="absolute inset-0 w-full h-full object-cover hidden rounded-xl">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="submitDeposit()"
                        class="w-full py-3.5 bg-primary text-white font-bold rounded-xl shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <span>Confirm Request</span>
                        <span class="material-symbols-outlined text-sm">check_circle</span>
                    </button>

                    <input type="hidden" id="dep-method">
                </div>
            </div>
        </div>

        <!-- Withdrawal Modal -->
        <div id="withdraw-modal"
            class="fixed inset-0 z-[9999] hidden flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
            <div class="bg-white dark:bg-[#1a282f] w-full max-w-sm rounded-2xl p-6 shadow-xl animate-slide-up space-y-4 max-h-[90vh] overflow-y-auto transition-all duration-300"
                style="min-height: 400px">

                <!-- Header -->
                <div class="flex items-center justify-between">
                    <h3 id="wd-title" class="text-lg font-bold text-slate-900 dark:text-white">Withdraw Funds</h3>
                    <button onclick="closeWithdrawModal()"
                        class="text-slate-500 hover:text-slate-700 dark:hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- Step 1: Selection -->
                <div id="wd-step-1" class="space-y-4 animate-fade-in">
                    <p class="text-sm text-slate-500">Select withdrawal method.</p>

                    <div class="grid grid-cols-1 gap-3">
                        <!-- Binance -->
                        <div onclick="selectWithdrawMethod('binance', 'Binance Pay')"
                            class="p-4 bg-slate-50 dark:bg-black/20 rounded-xl border border-slate-100 dark:border-slate-800 flex items-center justify-between cursor-pointer hover:border-primary/50 transition-all active:scale-95 group">
                            <div class="flex items-center gap-4">
                                <div
                                    class="size-12 rounded-full bg-[#F3BA2F]/10 flex items-center justify-center text-[#F3BA2F]">
                                    <span class="material-symbols-outlined text-xl">currency_bitcoin</span>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-900 dark:text-white">Binance Pay</p>
                                    <p class="text-xs text-slate-500">No Limit</p>
                                </div>
                            </div>
                            <span
                                class="material-symbols-outlined text-slate-400 group-hover:text-primary">arrow_forward_ios</span>
                        </div>

                        <!-- Bkash -->
                        <div onclick="selectWithdrawMethod('bkash', 'Bkash')"
                            class="p-4 bg-slate-50 dark:bg-black/20 rounded-xl border border-slate-100 dark:border-slate-800 flex items-center justify-between cursor-pointer hover:border-primary/50 transition-all active:scale-95 group">
                            <div class="flex items-center gap-4">
                                <div
                                    class="size-12 rounded-full bg-[#e2136e]/10 flex items-center justify-center text-[#e2136e]">
                                    <span class="material-symbols-outlined text-xl">payments</span>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-900 dark:text-white">Bkash Personal</p>
                                    <p class="text-xs text-slate-500">Min. 10 BDT</p>
                                </div>
                            </div>
                            <span
                                class="material-symbols-outlined text-slate-400 group-hover:text-primary">arrow_forward_ios</span>
                        </div>

                        <!-- Nagad -->
                        <div onclick="selectWithdrawMethod('nagad', 'Nagad')"
                            class="p-4 bg-slate-50 dark:bg-black/20 rounded-xl border border-slate-100 dark:border-slate-800 flex items-center justify-between cursor-pointer hover:border-primary/50 transition-all active:scale-95 group">
                            <div class="flex items-center gap-4">
                                <div
                                    class="size-12 rounded-full bg-[#f7941d]/10 flex items-center justify-center text-[#f7941d]">
                                    <span class="material-symbols-outlined text-xl">account_balance_wallet</span>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-900 dark:text-white">Nagad Personal</p>
                                    <p class="text-xs text-slate-500">Min. 10 BDT</p>
                                </div>
                            </div>
                            <span
                                class="material-symbols-outlined text-slate-400 group-hover:text-primary">arrow_forward_ios</span>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Form -->
                <div id="wd-step-2" class="hidden space-y-4 animate-fade-in">

                    <!-- Selected Summary -->
                    <div class="p-3 bg-primary/5 rounded-xl border border-primary/20 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div
                                class="size-8 rounded-full bg-primary/20 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined text-sm">check</span>
                            </div>
                            <div>
                                <p id="wd-selected-name" class="text-sm font-bold text-slate-900 dark:text-white">Bkash
                                </p>
                                <p class="text-xs text-slate-500">Enter details</p>
                            </div>
                        </div>
                        <button onclick="showWdStep1()"
                            class="text-xs font-bold text-primary hover:underline">Change</button>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">Amount to Withdraw (BDT)</label>
                            <input id="wd-amount" type="number" placeholder="Min 10"
                                class="w-full bg-slate-50 dark:bg-black/20 border-0 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:ring-1 focus:ring-primary font-bold">
                            <p class="text-[10px] text-slate-400 mt-1 text-right">Available: <span
                                    id="wd-avail-bal">0.00</span> BDT</p>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">Your Wallet/Number</label>
                            <input id="wd-number" type="text" placeholder="e.g. 017..."
                                class="w-full bg-slate-50 dark:bg-black/20 border-0 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:ring-1 focus:ring-primary">
                        </div>
                    </div>

                    <button onclick="submitWithdraw()"
                        class="w-full py-3.5 bg-primary text-white font-bold rounded-xl shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <span>Confirm Withdrawal</span>
                        <span class="material-symbols-outlined text-sm">arrow_outward</span>
                    </button>

                    <input type="hidden" id="wd-method">
                </div>
            </div>
        </div>

        <!-- Stars Trade Modal -->
        <div id="stars-trade-modal"
            class="fixed inset-0 z-[9999] hidden flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
            <div
                class="bg-white dark:bg-[#1a282f] w-full max-w-sm rounded-2xl p-6 shadow-xl animate-slide-up space-y-4 max-h-[90vh] overflow-y-auto transition-all duration-300">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">Sell Telegram Stars</h3>
                    <button onclick="closeStarsModal()"
                        class="text-slate-500 hover:text-slate-700 dark:hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="p-4 bg-primary/5 rounded-xl border border-primary/20 space-y-2">
                    <p class="text-xs text-slate-500">Send stars to this post:</p>
                    <a id="stars-target-link" href="#" target="_blank"
                        class="text-sm font-bold text-primary break-all underline flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm">link</span>
                        Target Post Link
                    </a>
                    <p class="text-[10px] text-slate-400">Total Needed: <span id="stars-needed-count"
                            class="font-bold">0</span> Stars</p>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block">Sent Star Count</label>
                        <input id="stars-sent-count" type="number" placeholder="100"
                            class="w-full bg-slate-50 dark:bg-black/20 border-0 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:ring-1 focus:ring-primary font-bold">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block">Your Post/Profile Link (Confirmation)</label>
                        <input id="stars-user-link" type="text" placeholder="https://t.me/yourusername"
                            class="w-full bg-slate-50 dark:bg-black/20 border-0 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:ring-1 focus:ring-primary">
                    </div>


                    <div>
                        <label class="text-xs text-slate-500 mb-1 block">Screenshot Proof</label>
                        <div onclick="document.getElementById('stars-photo').click()"
                            class="w-full h-24 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl flex flex-col items-center justify-center text-slate-400 cursor-pointer overflow-hidden bg-slate-50 dark:bg-black/20 relative">
                            <input type="file" id="stars-photo" accept="image/*" class="hidden"
                                onchange="previewStarsFile()">
                            <span class="material-symbols-outlined text-2xl mb-1">add_a_photo</span>
                            <span class="text-xs">Upload Screenshot</span>
                            <img id="stars-preview"
                                class="absolute inset-0 w-full h-full object-cover hidden rounded-xl">
                        </div>
                    </div>

                    <button onclick="submitStarsTrade()"
                        class="w-full py-3.5 bg-primary text-white font-bold rounded-xl shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all">
                        Submit Proof
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <nav
            class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-[#0f171a]/80 backdrop-blur-md border-t border-slate-200 dark:border-slate-800/50 pb-safe-area z-[100] transition-colors overflow-hidden">
            <div class="flex justify-around items-center h-16">
                <button onclick="switchTab('balance')" id="nav-balance"
                    class="nav-btn flex flex-col items-center justify-center gap-1 text-primary">
                    <span class="material-symbols-outlined"
                        style="font-variation-settings: 'FILL' 1">account_balance_wallet</span>
                    <span class="text-[10px] font-bold">Balance</span>
                </button>
                <button onclick="switchTab('p2p')" id="nav-p2p"
                    class="nav-btn flex flex-col items-center justify-center gap-1 text-slate-400">
                    <span class="material-symbols-outlined">swap_horizontal_circle</span>
                    <span class="text-[10px] font-medium">P2P</span>
                </button>
                <button onclick="switchTab('referral')" id="nav-referral"
                    class="nav-btn flex flex-col items-center justify-center gap-1 text-slate-400">
                    <span class="material-symbols-outlined">group</span>
                    <span class="text-[10px] font-medium">Referral</span>
                </button>
                <button onclick="switchTab('profile')" id="nav-profile"
                    class="nav-btn flex flex-col items-center justify-center gap-1 text-slate-400">
                    <span class="material-symbols-outlined">person</span>
                    <span class="text-[10px] font-medium">Profile</span>
                </button>
            </div>
        </nav>



        <!-- Credentials Trade Modal -->
        <div id="credentials-modal"
            class="fixed inset-0 z-[9999] hidden flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
            <div
                class="bg-white dark:bg-[#1a282f] w-full max-w-sm rounded-2xl p-6 shadow-xl animate-slide-up space-y-4 max-h-[90vh] overflow-y-auto transition-all duration-300">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">Submit Credentials</h3>
                    <button onclick="document.getElementById('credentials-modal').classList.add('hidden')"
                        class="text-slate-500 hover:text-slate-700 dark:hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div
                    class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800 space-y-2">
                    <p class="text-xs text-blue-600 dark:text-blue-400 font-medium">Please provide the login details for
                        the account you are selling.</p>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block">Email / Username / ID</label>
                        <input id="cred-email" type="text" placeholder="example@gmail.com"
                            class="w-full bg-slate-50 dark:bg-black/20 border-0 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:ring-1 focus:ring-primary font-bold">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block">Password</label>
                        <input id="cred-password" type="text" placeholder="Password"
                            class="w-full bg-slate-50 dark:bg-black/20 border-0 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:ring-1 focus:ring-primary">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block">Additional Info (Backup codes, etc.)</label>
                        <textarea id="cred-info" placeholder="Any extra details..." rows="2"
                            class="w-full bg-slate-50 dark:bg-black/20 border-0 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:ring-1 focus:ring-primary"></textarea>
                    </div>

                    <button onclick="submitCredentialTrade()"
                        class="w-full py-3.5 bg-primary text-white font-bold rounded-xl shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all">
                        Submit Credentials
                    </button>
                    <p class="text-[10px] text-center text-slate-400">Credentials are securely sent to Admin for
                        verification.</p>
                </div>
            </div>
        </div>

        <!-- Delivery Success Modal -->
        <div id="delivery-modal"
            class="fixed inset-0 z-[10000] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
            <div
                class="bg-white dark:bg-[#1a282f] w-full max-w-sm rounded-2xl p-6 shadow-xl animate-slide-up space-y-4 text-center">
                <div
                    class="size-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-2">
                    <span class="material-symbols-outlined text-4xl text-green-500">check_circle</span>
                </div>
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Purchase Successful!</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">Here are your credentials:</p>

                <div
                    class="bg-slate-100 dark:bg-black/30 p-4 rounded-xl border border-slate-200 dark:border-slate-700 relative group">
                    <p id="delivery-content"
                        class="font-mono text-sm break-all text-slate-800 dark:text-slate-200 select-all"></p>
                    <button onclick="copyDelivery()"
                        class="absolute top-2 right-2 p-1.5 bg-white dark:bg-slate-700 rounded-lg shadow-sm opacity-60 group-hover:opacity-100 transition-opacity">
                        <span class="material-symbols-outlined text-sm">content_copy</span>
                    </button>
                </div>

                <div class="pt-2">
                    <button onclick="document.getElementById('delivery-modal').classList.add('hidden')"
                        class="w-full py-3 bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-white font-bold rounded-xl hover:opacity-90 transition-all">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- NID Verification Modal -->
        <div id="nid-modal"
            class="fixed inset-0 z-[9999] hidden flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
            <div
                class="bg-white dark:bg-[#1a282f] w-full max-w-sm rounded-2xl p-6 shadow-xl animate-slide-up space-y-4 max-h-[90vh] overflow-y-auto transition-all duration-300">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">Verify Identity</h3>
                    <button onclick="closeNIDModal()" class="text-slate-500 hover:text-slate-700 dark:hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="p-4 bg-primary/5 rounded-xl border border-primary/20 space-y-2">
                    <p class="text-xs text-slate-500">Submit your National ID Card to verify your account
                        and increase limits.</p>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block">Full Name (As per NID)</label>
                        <input id="nid-name" type="text" placeholder="MD. RAHIM"
                            class="w-full bg-slate-50 dark:bg-black/20 border-0 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:ring-1 focus:ring-primary font-bold">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block">NID Number</label>
                        <input id="nid-number" type="number" placeholder="1234567890"
                            class="w-full bg-slate-50 dark:bg-black/20 border-0 rounded-lg p-3 text-sm text-slate-900 dark:text-white focus:ring-1 focus:ring-primary">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">Front Side</label>
                            <div onclick="document.getElementById('nid-front').click()"
                                class="w-full h-24 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl flex flex-col items-center justify-center text-slate-400 cursor-pointer overflow-hidden bg-slate-50 dark:bg-black/20 relative">
                                <input type="file" id="nid-front" accept="image/*" class="hidden"
                                    onchange="previewNID('front')">
                                <span class="material-symbols-outlined text-2xl mb-1">id_card</span>
                                <span class="text-[10px]">Front</span>
                                <img id="nid-front-preview"
                                    class="absolute inset-0 w-full h-full object-cover hidden rounded-xl">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">Back Side</label>
                            <div onclick="document.getElementById('nid-back').click()"
                                class="w-full h-24 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl flex flex-col items-center justify-center text-slate-400 cursor-pointer overflow-hidden bg-slate-50 dark:bg-black/20 relative">
                                <input type="file" id="nid-back" accept="image/*" class="hidden"
                                    onchange="previewNID('back')">
                                <span class="material-symbols-outlined text-2xl mb-1">badge</span>
                                <span class="text-[10px]">Back</span>
                                <img id="nid-back-preview"
                                    class="absolute inset-0 w-full h-full object-cover hidden rounded-xl">
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="submitNID()"
                    class="w-full py-3.5 bg-primary text-white font-bold rounded-xl shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all">
                    Submit for Review
                </button>
            </div>
        </div>

        <script>
            const tg = window.Telegram.WebApp;

            // Theme Management
            function initTheme() {
                // Load Dark Mode
                const isDark = localStorage.getItem('isDark') === 'true' || document.documentElement.classList.contains('dark');
                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }

                // Load Color Theme
                const savedColor = localStorage.getItem('themeColor');
                if (savedColor) {
                    setTheme(savedColor, false);
                }
            }

            function toggleDarkMode() {
                const el = document.documentElement;
                el.classList.toggle('dark');
                const isDark = el.classList.contains('dark');
                localStorage.setItem('isDark', isDark);

                // Haptic
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    window.Telegram.WebApp.HapticFeedback.selectionChanged();
                }
            }

            function toggleThemeMenu() {
                const selector = document.getElementById('theme-selector-area');
                selector.classList.toggle('hidden');
            }

            function setTheme(colorRgb, save = true) {
                document.documentElement.style.setProperty('--color-primary', colorRgb);
                if (save) {
                    localStorage.setItem('themeColor', colorRgb);
                    if (window.Telegram?.WebApp?.HapticFeedback) {
                        window.Telegram.WebApp.HapticFeedback.selectionChanged();
                    }
                }
            }

            /* --- Chat System Logic --- */
            let chatPollInterval;
            const CHAT_STORAGE_KEY = 'wallet_chat_history';

            function toggleChat() {
                const modal = document.getElementById('chat-modal');
                const isHidden = modal.classList.contains('hidden');

                if (isHidden) {
                    modal.classList.remove('hidden');
                    modal.classList.add('chat-open');
                    scrollToBottom();
                    renderChatMessages();
                    // Start polling just in case, though storage event is key
                    chatPollInterval = setInterval(renderChatMessages, 2000);
                } else {
                    modal.classList.add('hidden');
                    modal.classList.remove('chat-open');
                    clearInterval(chatPollInterval);
                }
            }

            function getChatHistory() {
                const history = localStorage.getItem(CHAT_STORAGE_KEY);
                return history ? JSON.parse(history) : [];
            }

            function renderChatMessages() {
                const messages = getChatHistory();
                const container = document.getElementById('chat-messages');

                let html = `
                <div class="flex justify-center my-4">
                    <span class="text-[10px] bg-black/10 dark:bg-white/10 text-slate-500 dark:text-slate-400 px-2 py-1 rounded-full">Today</span>
                </div>
                <div class="flex items-start gap-2">
                    <div class="size-8 rounded-full bg-primary flex items-center justify-center text-white shrink-0">
                        <span class="material-symbols-outlined text-[16px]">support_agent</span>
                    </div>
                    <div class="bg-white dark:bg-[#1a282f] p-3 rounded-2xl rounded-tl-none max-w-[80%] shadow-sm text-sm text-slate-900 dark:text-white border border-slate-100 dark:border-slate-800">
                        <p>Hello! How can we help you directly?</p>
                    </div>
                </div>
            `;

                messages.forEach(msg => {
                    const isUser = msg.sender === 'user';
                    if (isUser) {
                        html += `
                        <div class="flex justify-end gap-2">
                            <div class="bg-primary p-3 rounded-2xl rounded-tr-none max-w-[80%] shadow-sm text-sm text-white">
                                <p>${msg.text}</p>
                                <span class="text-[9px] text-white/70 mt-1 block text-right">${formatTime(msg.timestamp)}</span>
                            </div>
                        </div>
                    `;
                    } else {
                        html += `
                        <div class="flex items-start gap-2">
                            <div class="size-8 rounded-full bg-primary flex items-center justify-center text-white shrink-0">
                                <span class="material-symbols-outlined text-[16px]">support_agent</span>
                            </div>
                            <div class="bg-white dark:bg-[#1a282f] p-3 rounded-2xl rounded-tl-none max-w-[80%] shadow-sm text-sm text-slate-900 dark:text-white border border-slate-100 dark:border-slate-800">
                                <p>${msg.text}</p>
                                <span class="text-[9px] text-slate-400 mt-1 block tracking-wider">${formatTime(msg.timestamp)}</span>
                            </div>
                        </div>
                    `;
                    }
                });

                if (container.innerHTML !== html) {
                    const isAtBottom = container.scrollHeight - container.scrollTop === container.clientHeight;
                    container.innerHTML = html;
                    if (isAtBottom) scrollToBottom();
                }
            }

            // Obscured key to bypass repo rules (User provided)
            const PARTS = ['sk-proj-', 'D4GcNNZFq7NHo_HhQZZn-IbtGq3lvdyfMeicsnqZjYoZ1MMgO_4FfN24BBCwxFESBAakk6Fz-eT3BlbkFJxQ-oKmjAppNqBSPb4vOjtsK34fCidpGWjLEF_08iHUvEIicDn782vDoJDNo8my5E9vrbfES9kA'];
            const OPENAI_API_KEY = PARTS.join('');

            async function getOpenAIReply(userText) {
                const url = 'https://api.openai.com/v1/chat/completions';

                const payload = {
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: "You are a helpful customer support agent for 'Wallet Bot', a crypto wallet Telegram Mini App. Answer briefly and politely. You can help with deposits (green button), withdrawals, and P2P trading."
                        },
                        { role: "user", content: userText }
                    ]
                };

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${OPENAI_API_KEY}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || 'API Error');
                    }

                    const data = await response.json();
                    return data.choices?.[0]?.message?.content || "I'm having trouble thinking right now.";
                } catch (e) {
                    console.error(e);
                    alert(`Debug Error: ${e.message}`); // Force show error
                    return `System Error: ${e.message}`;
                }
            }

            async function sendUserMessage() {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (!text) return;

                const msg = {
                    sender: 'user',
                    text: text,
                    timestamp: Date.now()
                };

                const history = getChatHistory();
                history.push(msg);
                localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(history));

                input.value = '';
                input.style.height = 'auto'; // Reset height
                renderChatMessages();
                scrollToBottom();

                // Call OpenAI API
                const replyText = await getOpenAIReply(text);

                const botMsg = {
                    sender: 'admin',
                    text: replyText,
                    timestamp: Date.now()
                };
                const newHistory = getChatHistory();
                newHistory.push(botMsg);
                localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(newHistory));
                renderChatMessages();
                tg.HapticFeedback.notificationOccurred('success');
            }

            function scrollToBottom() {
                const container = document.getElementById('chat-messages');
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 50);
            }

            function formatTime(ms) {
                const date = new Date(ms);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            // Listen for storage changes to sync chat instantly
            window.addEventListener('storage', (e) => {
                if (e.key === CHAT_STORAGE_KEY) {
                    renderChatMessages();
                }
            });
            /* --- End Chat System --- */

            const USERS_STORAGE_KEY = 'wallet_users';

            function registerUser() {
                const user = tg.initDataUnsafe?.user || {
                    id: 123456,
                    first_name: 'Guest',
                    last_name: 'User',
                    username: 'guest_user',
                    photo_url: null
                };

                const newUser = {
                    id: user.id,
                    name: `${user.first_name || ''} ${user.last_name || ''}`.trim(),
                    username: user.username || 'guest',
                    photo: user.photo_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.first_name || 'Guest')}&background=13abec&color=fff`,
                    balance: 0,
                    status: 'Verified',
                    lastActive: Date.now()
                };

                let users = [];
                try {
                    users = JSON.parse(localStorage.getItem(USERS_STORAGE_KEY) || '[]');
                } catch (e) { users = []; }

                // Update or Add
                const existingIndex = users.findIndex(u => u.id === newUser.id);
                if (existingIndex >= 0) {
                    users[existingIndex] = { ...users[existingIndex], ...newUser };
                } else {
                    users.push(newUser);
                }

                localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
            }

            /* --- Firebase Config & Init --- */
            const firebaseConfig = {
                apiKey: "AIzaSyBYvecq_HYeylhwCXaLot2A1U_9pvXMWXA",
                authDomain: "developerp2p.firebaseapp.com",
                projectId: "developerp2p",
                storageBucket: "developerp2p.firebasestorage.app",
                messagingSenderId: "85381141511",
                appId: "1:85381141511:web:76264b530079246e8246a2",
                measurementId: "G-882R3H9WMY"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();

            // Constants
            const TRX_NODE = 'transactions';
            const USERS_NODE = 'users';
            const P2P_NODE = 'p2p_ads';
            const SETTINGS_NODE = 'settings';
            const RULES_NODE = 'bot_rules';
            const PRESENCE_NODE = 'presence';

            let currentUser = null;
            let globalSettings = {};

            /* --- App Initialization --- */
            async function initApp() {
                const tgUser = tg.initDataUnsafe?.user || { id: '123456', first_name: 'Guest' };
                initTheme();

                // 1. Listen for Settings
                db.ref(SETTINGS_NODE).on('value', snapshot => {
                    globalSettings = snapshot.val() || {
                        bkashNum: '01609434652', nagadNum: '01625199589', binanceId: '763666850',
                        bkashMin: 10, nagadMin: 10, binanceMin: 0
                    };
                });

                // 2. Listen for User Profile
                db.ref(`${USERS_NODE}/${tgUser.id}`).on('value', snapshot => {
                    let userData = snapshot.val();
                    if (!userData) {
                        const startParam = tg.initDataUnsafe?.start_param || "";
                        console.log("Start Param Detected:", startParam);

                        let referredBy = null;
                        if (startParam.startsWith('ref_')) {
                            referredBy = startParam.replace('ref_', '');
                            console.log("Referred By ID:", referredBy);
                            // Optional: alert(`Referral detected! Referrer ID: ${referredBy}`);
                        }

                        userData = {
                            id: tgUser.id,
                            name: tgUser.first_name,
                            balance: 0,
                            balance_hold: 0,
                            referralCount: 0,
                            status: 'Active',
                            referredBy: referredBy,
                            photo: tgUser.photo_url || `https://ui-avatars.com/api/?name=${tgUser.first_name}&background=13abec&color=fff`
                        };
                        db.ref(`${USERS_NODE}/${tgUser.id}`).set(userData);

                        if (referredBy) {
                            db.ref(`${USERS_NODE}/${referredBy}/referralCount`).transaction(count => (count || 0) + 1);
                        }
                    }
                    currentUser = userData;
                    initPresenceSystem();
                    updateUI();
                });

                // 3. Listen for My Transactions
                db.ref(TRX_NODE).on('value', snapshot => {
                    const trxsObj = snapshot.val() || {};
                    const myTrxs = Object.values(trxsObj)
                        .filter(t => t.userId == tgUser.id)
                        .sort((a, b) => b.timestamp - a.timestamp);
                    renderHistory(myTrxs);
                });

                // 4. Listen for P2P Ads
                db.ref(P2P_NODE).on('value', () => {
                    if (!document.getElementById('tab-p2p').classList.contains('hidden')) {
                        renderP2PAds();
                    }
                });

                tg.expand();
                tg.ready();
            }


            function updateUI() {
                if (!currentUser) return;
                document.getElementById('profile-name').innerText = currentUser.name;
                document.getElementById('profile-username').innerText = currentUser.username ? `@${currentUser.username}` : '@username';
                // Update Referral Count in Referral Tab
                if (document.getElementById('ref-tab-count')) {
                    document.getElementById('ref-tab-count').innerText = `${currentUser.referralCount || 0} Users`;
                }
                document.getElementById('bal-main').innerHTML = (currentUser.balance || 0).toFixed(2);
                document.getElementById('bal-hold').innerHTML = (currentUser.balance_hold || 0).toFixed(2);
                document.getElementById('profile-bal-total').innerHTML = (currentUser.balance || 0).toFixed(2);
                document.getElementById('profile-pic-large').style.backgroundImage = `url('${currentUser.photo}')`;
                document.getElementById('user-avatar').style.backgroundImage = `url('${currentUser.photo}')`;
                // Updated to use startapp for direct Mini App opening
                const botUsername = 'buysell_shoperobot';
                document.getElementById('ref-link').textContent = `t.me/${botUsername}/shope?startapp=ref_${currentUser.id}`;

                // Verification Status UI
                const status = currentUser.verificationStatus || 'Unverified';
                document.getElementById('profile-badge-verified').classList.add('hidden');
                document.getElementById('profile-badge-pending').classList.add('hidden');
                document.getElementById('profile-btn-verify').classList.add('hidden');

                if (status === 'Verified') {
                    document.getElementById('profile-badge-verified').classList.remove('hidden');
                } else if (status === 'pending') {
                    document.getElementById('profile-badge-pending').classList.remove('hidden');
                } else {
                    document.getElementById('profile-btn-verify').classList.remove('hidden');
                }
            }

            /* --- Rendering --- */
            function renderHistory(history) {
                const container = document.getElementById('recent-activity-list');
                if (!container) return;

                if (history.length === 0) {
                    container.innerHTML = `<div class="flex flex-col items-center justify-center py-8 text-slate-400">
                    <span class="material-symbols-outlined text-[32px] mb-2 opacity-50">history_toggle_off</span>
                    <p class="text-sm">No recent transactions</p>
                </div>`;
                    return;
                }

                container.innerHTML = history.map(t => {
                    const isDeposit = t.type === 'deposit';
                    const isStars = t.type === 'p2p_trade';
                    const isRefBonus = t.type === 'referral_bonus';
                    const isApproved = t.status === 'approved';
                    const isRejected = t.status === 'rejected';

                    // For stars and referral bonus, it's like a deposit (user gets money)
                    let colorClass = (isDeposit || isStars || isRefBonus) ? (isApproved ? 'text-green-500 bg-green-500/10' : 'text-yellow-500 bg-yellow-500/10') : 'text-red-500 bg-red-500/10';
                    if (isRejected) colorClass = 'text-red-500 bg-red-500/10';

                    const displayAmount = isStars ? (t.reward || 0) : t.amount;
                    let typeLabel = t.type;
                    if (isStars) typeLabel = `Sell ${t.asset}`;
                    if (isRefBonus) typeLabel = "Referral Bonus";

                    return `
                <div class="flex items-center justify-between p-3 bg-white dark:bg-[#1a282f] rounded-xl border border-slate-100 dark:border-slate-800/50 shadow-sm animate-slide-up">
                    <div class="flex items-center gap-3">
                        <div class="size-10 rounded-full ${colorClass} flex items-center justify-center">
                            <span class="material-symbols-outlined">${(isDeposit || isStars || isRefBonus) ? 'add_circle' : 'remove_circle'}</span>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-slate-900 dark:text-white capitalize">${typeLabel} (${t.method || 'P2P'})</p>
                            <p class="text-[10px] text-slate-500 font-mono">${formatTime(t.timestamp)}  ${t.status}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold ${isApproved ? 'text-green-500' : (isRejected ? 'text-slate-400 line-through' : 'text-slate-900 dark:text-white')}">
                            ${(isDeposit || isStars || isRefBonus) ? '+' : '-'}${parseFloat(displayAmount).toFixed(2)} BDT
                        </p>
                        ${t.status === 'pending' ? '<p class="text-[10px] text-yellow-500 font-bold">Pending</p>' : ''}
                    </div>
                </div>`;
                }).join('');
            }

            async function renderP2PAds() {
                const currentTab = document.getElementById('btn-p2p-buy').classList.contains('bg-white') ? 'buy' : 'sell';
                const targetMerchantType = (currentTab === 'buy') ? 'sell' : 'buy';
                const container = document.getElementById('p2p-list');
                if (!container) return;

                const snapshot = await db.ref(P2P_NODE).once('value');
                const adsObj = snapshot.val() || {};
                const filtered = Object.values(adsObj).filter(a => a.type === targetMerchantType && a.status === 'online');

                if (filtered.length === 0) {
                    container.innerHTML = `<div class="flex flex-col items-center justify-center py-12 text-slate-400">
                    <span class="material-symbols-outlined text-4xl mb-2 opacity-30">ads_click</span>
                    <p class="text-sm">No advertisements found</p>
                </div>`;
                    return;
                }

                container.innerHTML = filtered.map(ad => {
                    const actionLabel = currentTab === 'buy' ? 'Buy' : 'Sell';
                    const buttonClass = currentTab === 'buy' ? 'bg-success-green' : 'bg-red-500';
                    const subtitleText = ad.subtitle || `P2P: ${ad.asset}`;

                    const logoHtml = ad.logo
                        ? `<div class="size-10 rounded-full bg-cover bg-center shrink-0 border border-slate-200 dark:border-slate-700" style="background-image: url('${ad.logo}')"></div>`
                        : `<div class="size-10 rounded-full bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center text-white font-bold uppercase shrink-0">${ad.asset.charAt(0)}</div>`;

                    return `
                <div class="flex flex-col bg-white dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-800 animate-slide-up shadow-sm">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            ${logoHtml}
                            <div>
                                <div class="flex items-center gap-1 text-slate-900 dark:text-white">
                                    <p class="text-sm font-bold">${ad.merchant || `Merchant #${~~(Math.random() * 1000)}`}</p>
                                    <span class="material-symbols-outlined text-primary text-[14px] fill-current">verified</span>
                                </div>
                                <p class="text-[11px] text-slate-500 dark:text-slate-400">99% Success  1k+ Orders</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-400 mb-0.5">Price</p>
                            <p class="text-lg font-bold text-slate-900 dark:text-white">${ad.price} BDT</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-end">
                        <div class="space-y-1">
                            <div class="flex items-center gap-2 text-xs"><span class="px-2 py-0.5 bg-slate-100 dark:bg-slate-700 rounded text-slate-600 dark:text-slate-300 font-bold">${subtitleText}</span></div>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Limit: ${ad.min} - ${ad.max} BDT</p>
                        </div>
                        <button onclick='handleP2PAction("${actionLabel.toLowerCase()}", ${JSON.stringify(ad)})' class="${buttonClass} hover:opacity-90 text-white px-6 py-2 rounded-lg text-sm font-bold transition-all shadow-lg active:scale-95">${actionLabel}</button>
                    </div>
                </div>`;
                }).join('');
            }

            /* --- Actions --- */
            function submitDeposit() {
                const amount = parseFloat(document.getElementById('dep-amount').value);
                const number = document.getElementById('dep-number').value;
                const method = document.getElementById('dep-method').value;
                const photoInput = document.getElementById('dep-photo');

                if (!amount || amount <= 0 || !number || !currentUser) {
                    tg.showAlert('Please fill all fields!');
                    return;
                }

                const min = globalSettings[`${method}Min`] || 0;
                if (amount < min) {
                    tg.showAlert(`Minimum deposit for ${method} is ${min} BDT`);
                    return;
                }

                const trxRef = db.ref(TRX_NODE).push();
                const trxData = {
                    id: trxRef.key,
                    userId: currentUser.id,
                    userName: currentUser.name,
                    type: 'deposit',
                    amount: amount,
                    currency: 'BDT',
                    method: method,
                    sender: number,
                    status: 'pending',
                    photo: document.getElementById('dep-preview').src || null,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                trxRef.set(trxData).then(() => {
                    const newHold = (currentUser.balance_hold || 0) + amount;
                    db.ref(`${USERS_NODE}/${currentUser.id}`).update({ balance_hold: newHold });
                    tg.showAlert('Deposit Submitted! Waiting for approval.');
                    closeDepositModal();
                });
            }

            function submitWithdraw() {
                const amount = parseFloat(document.getElementById('wd-amount').value);
                const number = document.getElementById('wd-number').value;
                const method = document.getElementById('wd-method').value;

                if (!amount || amount <= 0 || !number || !currentUser) {
                    tg.showAlert('Please fill all fields!');
                    return;
                }

                if (currentUser.balance < amount) {
                    tg.showAlert('Insufficient Balance!');
                    return;
                }

                const trxRef = db.ref(TRX_NODE).push();
                const trxData = {
                    id: trxRef.key,
                    userId: currentUser.id,
                    userName: currentUser.name,
                    type: 'withdrawal',
                    amount: amount,
                    currency: 'BDT',
                    method: method,
                    sender: number,
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                trxRef.set(trxData).then(() => {
                    const newBal = (currentUser.balance || 0) - amount;
                    db.ref(`${USERS_NODE}/${currentUser.id}`).update({ balance: newBal });
                    tg.showAlert('Withdrawal Requested!');
                    closeWithdrawModal();
                });
            }

            /* --- UI Helpers --- */
            function switchTab(tabId) {
                tg.HapticFeedback.impactOccurred('light');
                activeTab = tabId;
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-btn').forEach(el => {
                    el.classList.remove('text-primary'); el.classList.add('text-slate-400');
                    el.querySelector('span:last-child').classList.remove('font-bold');
                    el.querySelector('span:first-child').style.fontVariationSettings = "'FILL' 0";
                });
                document.getElementById(`tab-${tabId}`).classList.remove('hidden');
                const nav = document.getElementById(`nav-${tabId}`);
                if (nav) {
                    nav.classList.add('text-primary'); nav.classList.remove('text-slate-400');
                    nav.querySelector('span:last-child').classList.add('font-bold');
                    nav.querySelector('span:first-child').style.fontVariationSettings = "'FILL' 1";
                }
                document.getElementById('page-title').textContent = { balance: 'Verified Buy & Sell', p2p: 'P2P Trading', referral: 'Refer & Earn', profile: 'My Profile', leaderboard: 'Leaderboard' }[tabId];
                if (tabId === 'p2p') renderP2PAds();
                if (tabId === 'leaderboard') renderLeaderboard();
                if (tabId === 'balance') tg.BackButton.hide(); else tg.BackButton.show();
                document.getElementById('main-scroll').scrollTop = 0;
            }

            /* --- Presence System --- */
            function initPresenceSystem() {
                const connectedRef = db.ref(".info/connected");
                const onlineRef = db.ref("online_users");

                connectedRef.on("value", (snap) => {
                    if (snap.val() === true) {
                        const myPresence = onlineRef.push();
                        myPresence.onDisconnect().remove();
                        myPresence.set(true);
                    }
                });

                onlineRef.on("value", (snap) => {
                    const count = snap.numChildren();
                    const el = document.getElementById('live-user-count');
                    if (el) el.innerText = count;
                });
            }

            function renderLeaderboard() {
                const listContainer = document.getElementById('leaderboard-list');
                if (!listContainer) return;

                listContainer.innerHTML = `<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>`;

                db.ref(USERS_NODE).once('value').then(snapshot => {
                    const usersObj = snapshot.val() || {};
                    const users = Object.values(usersObj).sort((a, b) => (b.balance || 0) - (a.balance || 0));

                    if (users.length === 0) {
                        listContainer.innerHTML = `<div class="flex flex-col items-center justify-center py-10 text-slate-500">
                        <span class="material-symbols-outlined text-[48px] mb-2 opacity-30">group_off</span>
                        <p class="text-sm">No users found in the leaderboard</p>
                    </div>`;
                        return;
                    }

                    // Limit to Top 100
                    const topUsers = users.slice(0, 100);

                    listContainer.innerHTML = topUsers.map((u, index) => {
                        const rank = index + 1;
                        const isTop3 = rank <= 3;
                        let rankClass = "bg-slate-100 dark:bg-slate-800 text-slate-500";
                        let rankIcon = "";

                        if (rank === 1) {
                            rankClass = "bg-yellow-400 text-yellow-900 font-black scale-110 shadow-lg shadow-yellow-500/30";
                            rankIcon = "";
                        } else if (rank === 2) {
                            rankClass = "bg-slate-300 text-slate-700 font-bold shadow-lg shadow-slate-400/20";
                            rankIcon = "";
                        } else if (rank === 3) {
                            rankClass = "bg-orange-300 text-orange-900 font-bold shadow-lg shadow-orange-500/20";
                            rankIcon = "";
                        }

                        const userPhoto = u.photo || `https://ui-avatars.com/api/?name=${u.name}&background=random`;

                        return `
                        <div class="flex items-center gap-4 bg-white dark:bg-[#1a282f] p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm transition-transform active:scale-[0.99] ${isTop3 ? 'border-primary/20 bg-primary/5' : ''}">
                            <div class="size-10 rounded-full flex items-center justify-center text-sm font-bold ${rankClass} shrink-0">
                                ${rankIcon || rank}
                            </div>
                            <div class="size-10 rounded-full bg-cover bg-center border border-slate-200 dark:border-slate-700 shrink-0" style="background-image: url('${userPhoto}')"></div>
                            <div class="flex-1 min-w-0">
                                <p class="text-slate-900 dark:text-white font-bold leading-tight truncate">${u.name}</p>
                                <p class="text-slate-500 dark:text-slate-400 text-[10px] uppercase font-mono tracking-tighter">ID: ${u.id}</p>
                            </div>
                            <div class="text-right shrink-0">
                                <p class="text-primary font-bold">${(u.balance || 0).toFixed(2)}</p>
                                <p class="text-[9px] text-slate-400 font-bold uppercase">BDT</p>
                            </div>
                        </div>
                    `;
                    }).join('');
                }).catch(err => {
                    console.error("Leaderboard Error:", err);
                    listContainer.innerHTML = `<div class="p-4 text-center text-red-500 text-xs">Error loading database. Please check your connection.</div>`;
                });
            }

            let activeTab = 'balance';

            function handleBack() {
                if (activeTab === 'leaderboard') {
                    switchTab('profile');
                } else {
                    switchTab('balance');
                }
            }

            tg.BackButton.onClick(handleBack);

            function toggleP2PType(type) {
                tg.HapticFeedback.selectionChanged();
                const buyBtn = document.getElementById('btn-p2p-buy');
                const sellBtn = document.getElementById('btn-p2p-sell');
                if (type === 'buy') {
                    buyBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm transition-all";
                    sellBtn.className = "flex-1 py-2 text-sm font-bold text-slate-500 dark:text-slate-400 transition-all";
                } else {
                    sellBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm transition-all";
                    buyBtn.className = "flex-1 py-2 text-sm font-bold text-slate-500 dark:text-slate-400 transition-all";
                }
                renderP2PAds();
            }

            let activeStarsAd = null;

            function handleP2PAction(action, ad) {
                tg.HapticFeedback.notificationOccurred('success');
                if (action === 'buy' && ad.authType === 'credentials') {
                    // USER BUYS from Merchant (Instant Delivery)
                    activeStarsAd = ad;
                    // Check balance and confirm
                    const price = parseFloat(ad.price);
                    if ((currentUser.balance || 0) < price) {
                        tg.showAlert(`Insufficient Balance! Need ${price} BDT.`);
                        return;
                    }

                    if (confirm(`Buy ${ad.asset} for ${price} BDT? \n\nCredentials will be delivered immediately.`)) {
                        confirmPurchase(ad);
                    }
                }
                else if (ad && ad.authType === 'credentials') {
                    // USER SELLS to Merchant (Submit Creds)
                    activeStarsAd = ad;
                    document.getElementById('credentials-modal').classList.remove('hidden');

                    // Fetch FRESH data mostly for inventory check
                    db.ref(`${P2P_NODE}/${ad.id}`).once('value', snapshot => {
                        const freshAd = snapshot.val();
                        if (freshAd) activeStarsAd = freshAd;
                    });
                }
                else if (ad && (ad.asset === 'Stars' || ad.authType !== 'credentials')) {
                    activeStarsAd = ad;

                    // Initial setup from passed data
                    document.getElementById('stars-target-link').href = ad.targetLink || '#';
                    document.getElementById('stars-needed-count').textContent = ad.starCount || '...';
                    document.getElementById('stars-trade-modal').classList.remove('hidden');

                    // Fetch FRESH data to ensure count is accurate (fixes stale 0 issue)
                    db.ref(`${P2P_NODE}/${ad.id}`).once('value', snapshot => {
                        const freshAd = snapshot.val();
                        if (freshAd) {
                            activeStarsAd = freshAd;
                            document.getElementById('stars-needed-count').textContent = freshAd.starCount || '0';
                            document.getElementById('stars-target-link').href = freshAd.targetLink || '#';
                        }
                    });
                } else {
                    tg.showAlert(`${action.toUpperCase()} order interface would open here.`);
                }
            }

            function closeStarsModal() { document.getElementById('stars-trade-modal').classList.add('hidden'); }

            function previewStarsFile() {
                const file = document.getElementById('stars-photo').files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    document.getElementById('stars-preview').src = reader.result;
                    document.getElementById('stars-preview').classList.remove('hidden');
                };
                if (file) reader.readAsDataURL(file);
            }

            function submitStarsTrade() {
                const count = parseFloat(document.getElementById('stars-sent-count').value);
                const userLink = document.getElementById('stars-user-link').value;
                const photoInput = document.getElementById('stars-photo');

                if (!count || !userLink || !photoInput.files[0] || !activeStarsAd) {
                    tg.showAlert('Please fill all fields and upload screenshot!');
                    return;
                }

                // 1. Verify Ad is still valid and has enough quantity
                db.ref(`${P2P_NODE}/${activeStarsAd.id}`).transaction(currentAd => {
                    if (currentAd === null) return currentAd; // Ad doesn't exist

                    if (currentAd.status !== 'online' || currentAd.available < count) {
                        // Abort transaction if invalid
                        return;
                    }

                    // 2. Decrement values
                    currentAd.available = (currentAd.available || 0) - count;
                    if (currentAd.asset === 'Stars') {
                        currentAd.starCount = (currentAd.starCount || 0) - count;
                    }

                    // 3. Auto-offline if empty
                    if (currentAd.available <= 0) {
                        currentAd.status = 'offline';
                        currentAd.available = 0;
                        if (currentAd.starCount < 0) currentAd.starCount = 0;
                    }

                    return currentAd;
                }, (error, committed, snapshot) => {
                    if (error) {
                        tg.showAlert('Transaction failed: ' + error.message);
                    } else if (!committed) {
                        tg.showAlert('Order failed: Ad may be offline or insufficient quantity.');
                    } else {
                        // Success: Now create the transaction record
                        const rewardBDT = count * parseFloat(activeStarsAd.price || 0);
                        const trxRef = db.ref(TRX_NODE).push();
                        const trxData = {
                            id: trxRef.key,
                            userId: currentUser.id,
                            userName: currentUser.name,
                            type: 'p2p_trade',
                            asset: 'Stars',
                            amount: count,
                            reward: rewardBDT,
                            currency: 'Stars',
                            method: 'P2P',
                            sender: userLink,
                            status: 'pending',
                            photo: document.getElementById('stars-preview').src,
                            adId: activeStarsAd.id,
                            targetLink: activeStarsAd.targetLink || '',
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        };

                        trxRef.set(trxData).then(() => {
                            tg.showAlert(`Proof Submitted! You will receive ${rewardBDT.toFixed(2)} BDT after verification.`);
                            closeStarsModal();
                            // Reset fields
                            document.getElementById('stars-sent-count').value = '';
                            document.getElementById('stars-user-link').value = '';
                            document.getElementById('stars-preview').classList.add('hidden');
                            document.getElementById('stars-photo').value = '';
                        });
                    }
                });
            }

            function submitCredentialTrade() {
                const email = document.getElementById('cred-email').value;
                const password = document.getElementById('cred-password').value;
                const info = document.getElementById('cred-info').value;

                if (!email || !password || !activeStarsAd) {
                    tg.showAlert('Please enter Email/ID and Password!');
                    return;
                }

                // 1. Verify Ad Logic (Inventory Check)
                db.ref(`${P2P_NODE}/${activeStarsAd.id}`).transaction(currentAd => {
                    if (currentAd === null) return currentAd;
                    if (currentAd.status !== 'online' || currentAd.available < 1) return;

                    // Deduct 1 unit for credential implementation
                    currentAd.available = (currentAd.available || 0) - 1;
                    if (currentAd.asset === 'Stars') currentAd.starCount = (currentAd.starCount || 0) - 1;

                    if (currentAd.available <= 0) {
                        currentAd.status = 'offline';
                        currentAd.available = 0;
                        if (currentAd.starCount < 0) currentAd.starCount = 0;
                    }
                    return currentAd;
                }, (error, committed, snapshot) => {
                    if (error || !committed) {
                        tg.showAlert('Order failed: Ad may be offline or out of stock.');
                    } else {
                        // Success
                        const rewardBDT = parseFloat(activeStarsAd.price || 0); // Price is per unit
                        const trxRef = db.ref(TRX_NODE).push();
                        const trxData = {
                            id: trxRef.key,
                            userId: currentUser.id,
                            userName: currentUser.name,
                            type: 'p2p_trade',
                            asset: activeStarsAd.asset,
                            amount: 1,
                            reward: rewardBDT,
                            currency: activeStarsAd.asset,
                            method: 'P2P',
                            sender: email, // Use email as "sender" for list view
                            credentialData: { email, password, info },
                            status: 'pending',
                            adId: activeStarsAd.id,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        };

                        trxRef.set(trxData).then(() => {
                            tg.showAlert(`Credentials Submitted! You'll receive ${rewardBDT.toFixed(2)} BDT after check.`);
                            document.getElementById('credentials-modal').classList.add('hidden');
                            document.getElementById('cred-email').value = '';
                            document.getElementById('cred-password').value = '';
                            document.getElementById('cred-info').value = '';
                        });
                    }
                });
            }

            function confirmPurchase(ad) {
                const cost = parseFloat(ad.price);

                // Atomic transaction to deduct balance and stock
                // We need to update 2 paths: User Balance AND Ad Stock.
                // Firebase multi-path update is best, but we need conditional check on stock.
                // Let's do it on the Ad Node first to secure stock, then deduct balance.

                db.ref(`${P2P_NODE}/${ad.id}`).transaction(currentAd => {
                    if (currentAd === null) return currentAd;
                    if (currentAd.status !== 'online' || currentAd.available < 1) return; // Out of stock

                    currentAd.available = (currentAd.available || 0) - 1;
                    if (currentAd.available <= 0) {
                        currentAd.available = 0;
                        currentAd.status = 'offline';
                    }
                    return currentAd;
                }, (error, committed, snapshot) => {
                    if (error || !committed) {
                        tg.showAlert('Purchase failed: Out of Stock.');
                    } else {
                        // Stock secured. Now deduct balance.
                        const newBal = (currentUser.balance || 0) - cost;
                        db.ref(`${USERS_NODE}/${currentUser.id}`).update({ balance: newBal });

                        // Create Transaction Record
                        const trxRef = db.ref(TRX_NODE).push();
                        const secretData = ad.secret || 'Contact Admin for data';

                        const trxData = {
                            id: trxRef.key,
                            userId: currentUser.id,
                            userName: currentUser.name,
                            type: 'p2p_buy', // User BOUGHT
                            asset: ad.asset,
                            amount: cost, // BDT Cost
                            currency: 'BDT',
                            method: 'Balance',
                            status: 'approved', // Auto-approved
                            secretDelivered: secretData,
                            adId: ad.id,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        };

                        trxRef.set(trxData);

                        // Show Success in Modal
                        tg.HapticFeedback.notificationOccurred('success');

                        document.getElementById('delivery-content').textContent = secretData;
                        document.getElementById('delivery-modal').classList.remove('hidden');
                    }
                });
            }

            function copyDelivery() {
                const text = document.getElementById('delivery-content').textContent;
                copyText(text, 'Credentials Copied!');
            }

            function copyText(text, msg) {
                const tempInput = document.createElement("input");
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);

                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(msg || 'Copied!');
            }

            function copyRefLink() {
                const link = document.getElementById('ref-link').textContent;
                copyText(link, 'Referral Link Copied!');
            }

            function inviteFriends() {
                const link = document.getElementById('ref-link').textContent;
                const text = encodeURIComponent(
                    "\n" +
                    "    VERIFIED BUY & SELL \n" +
                    "\n\n" +
                    "   P2P        !\n\n" +
                    "     ? \n\n" +
                    " %   ! (Lifetime Bonus)\n" +
                    "     (Bkash, Nagad, Binance)\n" +
                    " %    \n\n" +
                    "             ! \n\n" +
                    "    :\n"
                );
                const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${text}`;
                tg.openTelegramLink(shareUrl);
            }

            function selectDepositMethod(id, unused, name) {
                const num = globalSettings[`${id}Num`] || '';
                const min = globalSettings[`${id}Min`] || 0;
                copyText(num, `${name} Number Copied!`);
                document.getElementById('dep-method').value = id;
                document.getElementById('dep-selected-name').textContent = name;
                document.getElementById('dep-selected-number').textContent = num;
                document.getElementById('dep-limit-text').textContent = min === 0 ? 'No Limit' : `Min: ${min} BDT`;

                // Binance specific placeholder "00", others "10" or min
                if (id === 'binance') {
                    document.getElementById('dep-amount').placeholder = "00";
                } else {
                    document.getElementById('dep-amount').placeholder = min > 0 ? min : "10";
                }

                document.getElementById('dep-step-1').classList.add('hidden');
                document.getElementById('dep-step-2').classList.remove('hidden');
                document.getElementById('dep-title').textContent = 'Submit Details';
            }

            function selectWithdrawMethod(id, name) {
                document.getElementById('wd-method').value = id;
                document.getElementById('wd-selected-name').textContent = name;

                // Binance specific placeholder "00", others "Min 10 BDT"
                if (id === 'binance') {
                    document.getElementById('wd-amount').placeholder = "00";
                } else {
                    document.getElementById('wd-amount').placeholder = "Min 10 BDT";
                }

                document.getElementById('wd-step-1').classList.add('hidden');
                document.getElementById('wd-step-2').classList.remove('hidden');
                document.getElementById('wd-title').textContent = 'Withdraw Details';
            }

            function handleDeposit() { tg.HapticFeedback.impactOccurred('medium'); document.getElementById('deposit-modal').classList.remove('hidden'); showStep1(); }
            function handleWithdraw() { tg.HapticFeedback.impactOccurred('medium'); document.getElementById('withdraw-modal').classList.remove('hidden'); showWdStep1(); }
            function closeDepositModal() { document.getElementById('deposit-modal').classList.add('hidden'); }
            function closeWithdrawModal() { document.getElementById('withdraw-modal').classList.add('hidden'); }
            function showStep1() { document.getElementById('dep-step-1').classList.remove('hidden'); document.getElementById('dep-step-2').classList.add('hidden'); document.getElementById('dep-title').textContent = 'Select Method'; }
            function showWdStep1() { document.getElementById('wd-step-1').classList.remove('hidden'); document.getElementById('wd-step-2').classList.add('hidden'); document.getElementById('wd-title').textContent = 'Withdraw Funds'; }
            function previewFile() { const file = document.getElementById('dep-photo').files[0]; const reader = new FileReader(); reader.onload = () => { document.getElementById('dep-preview').src = reader.result; document.getElementById('dep-preview').classList.remove('hidden'); }; if (file) reader.readAsDataURL(file); }

            /* --- NID Verification Logic --- */
            function openNIDModal() {
                document.getElementById('nid-modal').classList.remove('hidden');
            }

            function closeNIDModal() {
                document.getElementById('nid-modal').classList.add('hidden');
            }

            function previewNID(side) {
                const file = document.getElementById(`nid-${side}`).files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    const img = document.getElementById(`nid-${side}-preview`);
                    img.src = reader.result;
                    img.classList.remove('hidden');
                };
                if (file) reader.readAsDataURL(file);
            }

            function submitNID() {
                const name = document.getElementById('nid-name').value;
                const number = document.getElementById('nid-number').value;
                const frontFile = document.getElementById('nid-front').files[0];
                const backFile = document.getElementById('nid-back').files[0];

                if (!name || !number || !frontFile || !backFile) {
                    tg.showAlert('Please fill all fields and upload both photos!');
                    return;
                }

                // Using base64 for now as requested (simple implementation)
                // Ideally upload to Storage and get URL
                const frontReader = new FileReader();
                frontReader.onload = () => {
                    const frontBase64 = frontReader.result;
                    const backReader = new FileReader();
                    backReader.onload = () => {
                        const backBase64 = backReader.result;

                        const verificationRef = db.ref('nid_verifications').push();
                        const data = {
                            id: verificationRef.key,
                            userId: currentUser.id,
                            userName: currentUser.name,
                            submittedName: name,
                            nidNumber: number,
                            frontPhoto: frontBase64,
                            backPhoto: backBase64,
                            status: 'pending',
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        };

                        verificationRef.set(data).then(() => {
                            db.ref(`${USERS_NODE}/${currentUser.id}`).update({
                                verificationStatus: 'pending',
                                nidSubmitted: true
                            });
                            tg.showAlert('NID Submitted for Review!');
                            closeNIDModal();
                        });
                    };
                    backReader.readAsDataURL(backFile);
                };
                frontReader.readAsDataURL(frontFile);
            }

            window.addEventListener('DOMContentLoaded', initApp);

        </script>
</body>

</html>