<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13abec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101c22",
                        "success-green": "#22c55e",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .nav-item.active {
            background-color: rgba(19, 171, 236, 0.1);
            color: #13abec;
            border-right: 3px solid #13abec;
        }

        .nav-item {
            border-right: 3px solid transparent;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white transition-colors duration-300">

    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar -->
        <aside
            class="hidden md:flex flex-col w-64 bg-white dark:bg-[#1a282f] border-r border-slate-200 dark:border-slate-800">
            <div class="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-800">
                <div
                    class="size-8 rounded bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center text-white font-bold mr-3">
                    W</div>
                <span class="font-bold text-lg tracking-tight">Verified Buy & Sell Admin</span>
            </div>

            <nav class="flex-1 py-6 space-y-1">
                <button onclick="switchView('dashboard')" id="nav-dashboard"
                    class="nav-item active w-full flex items-center px-6 py-3 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors text-left">
                    <span class="material-symbols-outlined mr-3">dashboard</span>
                    Dashboard
                </button>
                <button onclick="switchView('users')" id="nav-users"
                    class="nav-item w-full flex items-center px-6 py-3 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:hover:text-white transition-colors text-left">
                    <span class="material-symbols-outlined mr-3">group</span>
                    User Management
                </button>
                <button onclick="switchView('p2p')" id="nav-p2p"
                    class="nav-item w-full flex items-center px-6 py-3 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:hover:text-white transition-colors text-left">
                    <span class="material-symbols-outlined mr-3">currency_exchange</span>
                    P2P System
                </button>
                <button onclick="switchView('settings')" id="nav-settings"
                    class="nav-item w-full flex items-center px-6 py-3 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:hover:text-white transition-colors text-left">
                    <span class="material-symbols-outlined mr-3">settings</span>
                    App Settings
                </button>
                <button onclick="switchView('deposits')" id="nav-deposits"
                    class="nav-item w-full flex items-center px-6 py-3 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:hover:text-white transition-colors text-left">
                    <span class="material-symbols-outlined mr-3">payments</span>
                    Deposit Requests
                </button>
                <button onclick="switchView('verifications')" id="nav-verifications"
                    class="nav-item w-full flex items-center px-6 py-3 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:hover:text-white transition-colors text-left">
                    <span class="material-symbols-outlined mr-3">badge</span>
                    Identity Verification
                </button>
                <button onclick="switchView('withdrawals')" id="nav-withdrawals"
                    class="nav-item w-full flex items-center px-6 py-3 text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:hover:text-white transition-colors text-left">
                    <span class="material-symbols-outlined mr-3">money_off</span>
                    Withdrawals
                </button>
            </nav>

            <div class="p-4 border-t border-slate-200 dark:border-slate-800">
                <div class="flex items-center gap-3">
                    <div class="size-9 rounded-full bg-slate-200 dark:bg-slate-700"></div>
                    <div>
                        <p class="text-sm font-bold">Admin User</p>
                        <p class="text-xs text-slate-500">Super Admin</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
            <!-- Mobile Header -->
            <header
                class="md:hidden flex items-center justify-between h-16 px-4 bg-white dark:bg-[#1a282f] border-b border-slate-200 dark:border-slate-800">
                <span class="font-bold text-lg">Admin Panel</span>
                <button class="p-2 -mr-2 text-slate-500">
                    <span class="material-symbols-outlined">menu</span>
                </button>
            </header>

            <main class="flex-1 overflow-y-auto p-4 md:p-8">

                <!-- VIEW: DASHBOARD -->
                <div id="view-dashboard" class="view-section">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Dashboard Overview</h1>
                        <p class="text-sm text-slate-500">Welcome back, here's what's happening today.</p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div
                            class="bg-white dark:bg-[#1a282f] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Collection</h3>
                                <span
                                    class="material-symbols-outlined text-green-500 bg-green-500/10 p-1.5 rounded-lg">payments</span>
                            </div>
                            <p id="dash-total-collection" class="text-2xl font-bold">0.00 BDT</p>
                            <p class="text-xs text-slate-500 flex items-center gap-1 mt-1 font-medium">
                                Total approved deposits
                            </p>
                        </div>
                        <div
                            class="bg-white dark:bg-[#1a282f] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Users</h3>
                                <span
                                    class="material-symbols-outlined text-primary bg-primary/10 p-1.5 rounded-lg">group</span>
                            </div>
                            <p id="dash-total-users" class="text-2xl font-bold">0</p>
                            <p class="text-xs text-slate-500 flex items-center gap-1 mt-1 font-medium">
                                Registered members
                            </p>
                        </div>
                        <div
                            class="bg-white dark:bg-[#1a282f] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Pending Requests</h3>
                                <span
                                    class="material-symbols-outlined text-orange-500 bg-orange-500/10 p-1.5 rounded-lg">pending_actions</span>
                            </div>
                            <p id="dash-pending-reqs" class="text-2xl font-bold">0</p>
                            <p class="text-xs text-slate-500 flex items-center gap-1 mt-1 font-medium">
                                Needs your attention
                            </p>
                        </div>
                    </div>
                </div>

                <!-- VIEW: SETTINGS -->
                <div id="view-settings" class="view-section hidden">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">App Settings</h1>
                        <p class="text-sm text-slate-500">Configure payment methods and limits.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Payment Methods -->
                        <div
                            class="bg-white dark:bg-[#1a282f] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">account_balance_wallet</span>
                                Payment Accounts
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Bkash Number
                                        (Personal)</label>
                                    <input type="text" id="set-bkash-num" placeholder="01..."
                                        class="w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Nagad Number
                                        (Personal)</label>
                                    <input type="text" id="set-nagad-num" placeholder="01..."
                                        class="w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Binance Pay ID</label>
                                    <input type="text" id="set-binance-id" placeholder="123..."
                                        class="w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm">
                                </div>
                            </div>
                        </div>

                        <!-- Limits -->
                        <div
                            class="bg-white dark:bg-[#1a282f] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-orange-500">tune</span>
                                Transaction Limits
                            </h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">Bkash Min
                                            (BDT)</label>
                                        <input type="number" id="set-bkash-min" placeholder="10"
                                            class="w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm font-bold">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">Nagad Min
                                            (BDT)</label>
                                        <input type="number" id="set-nagad-min" placeholder="10"
                                            class="w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm font-bold">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Binance Min (BDT)</label>
                                    <input type="number" id="set-binance-min" placeholder="0"
                                        class="w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm font-bold">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button onclick="saveSettings()"
                            class="bg-primary text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-primary/20 hover:scale-[1.02] transition-transform">Save
                            All Changes</button>
                    </div>
                </div>

                <!-- VIEW: USERS -->
                <div id="view-users" class="view-section hidden">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">User Management</h1>
                            <p class="text-sm text-slate-500">Manage all registered users and their accounts.</p>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" placeholder="Search user ID, email..."
                                class="bg-white dark:bg-[#1a282f] border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-primary focus:border-primary">
                            <button
                                class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-primary/20 hover:bg-primary/90 transition-colors">Export
                                CSV</button>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-[#1a282f] rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead
                                    class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 uppercase tracking-wider text-xs">
                                    <tr>
                                        <th class="px-6 py-3 font-semibold">User Info</th>
                                        <th class="px-6 py-3 font-semibold">KYC Status</th>
                                        <th class="px-6 py-3 font-semibold">Wallet Balance</th>
                                        <th class="px-6 py-3 font-semibold">Role</th>
                                        <th class="px-6 py-3 font-semibold text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
                                    <!-- User Row 1 -->
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-3">
                                                <div class="size-8 rounded-full bg-slate-200 bg-cover"
                                                    style="background-image: url('https://ui-avatars.com/api/?name=Munna+Dev&background=13abec&color=fff');">
                                                </div>
                                                <div>
                                                    <p class="font-medium text-slate-900 dark:text-white">Munna
                                                        Developer</p>
                                                    <p class="text-xs text-slate-500">ID: 8839201</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span
                                                class="inline-flex px-2 py-1 text-[10px] font-bold uppercase rounded-full bg-green-100 text-green-600 dark:bg-green-500/10 dark:text-green-500">Verified</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <p class="font-medium">12,500.00 BDT</p>
                                        </td>
                                        <td class="px-6 py-4">User</td>
                                        <td class="px-6 py-4 text-right">
                                            <button
                                                class="text-primary hover:bg-primary/10 p-1 rounded transition-colors"
                                                title="Edit"><span
                                                    class="material-symbols-outlined text-[18px]">edit</span></button>
                                            <button
                                                class="text-red-500 hover:bg-red-500/10 p-1 rounded transition-colors"
                                                title="Ban"><span
                                                    class="material-symbols-outlined text-[18px]">block</span></button>
                                        </td>
                                    </tr>
                                    <!-- User Row 2 -->
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-3">
                                                <div class="size-8 rounded-full bg-slate-200 bg-cover"
                                                    style="background-image: url('https://ui-avatars.com/api/?name=John+D&background=random');">
                                                </div>
                                                <div>
                                                    <p class="font-medium text-slate-900 dark:text-white">John Doe</p>
                                                    <p class="text-xs text-slate-500">ID: 1029384</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span
                                                class="inline-flex px-2 py-1 text-[10px] font-bold uppercase rounded-full bg-yellow-100 text-yellow-600 dark:bg-yellow-500/10 dark:text-yellow-500">Pending</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <p class="font-medium">450.00 BDT</p>
                                        </td>
                                        <td class="px-6 py-4">User</td>
                                        <td class="px-6 py-4 text-right">
                                            <button
                                                class="text-primary hover:bg-primary/10 p-1 rounded transition-colors"><span
                                                    class="material-symbols-outlined text-[18px]">edit</span></button>
                                            <button
                                                class="text-red-500 hover:bg-red-500/10 p-1 rounded transition-colors"><span
                                                    class="material-symbols-outlined text-[18px]">block</span></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="px-6 py-3 border-t border-slate-200 dark:border-slate-800 flex justify-end">
                            <div class="flex gap-2">
                                <button
                                    class="px-3 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors disabled:opacity-50">Previous</button>
                                <button
                                    class="px-3 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors bg-slate-100 dark:bg-slate-800">1</button>
                                <button
                                    class="px-3 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">2</button>
                                <button
                                    class="px-3 py-1 text-sm border border-slate-200 dark:border-slate-700 rounded hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">Next</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: DEPOSIT REQUESTS -->
                <div id="view-deposits" class="view-section hidden">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Deposit Requests</h1>
                        <p class="text-sm text-slate-500">Approve or reject manual deposit proofs.</p>
                    </div>

                    <div
                        class="bg-white dark:bg-[#1a282f] rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead
                                    class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 uppercase tracking-wider text-xs">
                                    <tr>
                                        <th class="px-6 py-3">User</th>
                                        <th class="px-6 py-3">Amount</th>
                                        <th class="px-6 py-3">Method / Sender</th>
                                        <th class="px-6 py-3">Proof</th>
                                        <th class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="deposits-table-body" class="divide-y divide-slate-200 dark:divide-slate-800">
                                    <!-- Injected -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Held Transactions Section -->
                    <div id="held-transactions-section" class="mt-8 mb-4 hidden">
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-orange-500">pause_circle</span>
                            Held Transactions
                        </h2>
                        <p class="text-sm text-slate-500">Transactions waiting for final approval.</p>
                    </div>

                    <div
                        class="bg-white dark:bg-[#1a282f] rounded-xl border border-orange-200 dark:border-orange-900/50 shadow-sm overflow-hidden mb-6 hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead
                                    class="bg-orange-50 dark:bg-orange-900/10 text-orange-600 dark:text-orange-400 uppercase tracking-wider text-xs">
                                    <tr>
                                        <th class="px-6 py-3">User</th>
                                        <th class="px-6 py-3">Amount</th>
                                        <th class="px-6 py-3">Method / Sender</th>
                                        <th class="px-6 py-3">Proof</th>
                                        <th class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="held-deposits-table-body"
                                    class="divide-y divide-orange-100 dark:divide-orange-900/20"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: IDENTITY VERIFICATION -->
                <div id="view-verifications" class="view-section hidden">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Identity Verification</h1>
                        <p class="text-sm text-slate-500">Review and approve user NID submissions.</p>
                    </div>

                    <div
                        class="bg-white dark:bg-[#1a282f] rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead
                                    class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 uppercase tracking-wider text-xs">
                                    <tr>
                                        <th class="px-6 py-3 font-semibold">User Info</th>
                                        <th class="px-6 py-3 font-semibold">Submitted Name</th>
                                        <th class="px-6 py-3 font-semibold">NID Number</th>
                                        <th class="px-6 py-3 font-semibold">Documents</th>
                                        <th class="px-6 py-3 font-semibold text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="verifications-table-body"
                                    class="divide-y divide-slate-200 dark:divide-slate-800">
                                    <!-- Injected via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: WITHDRAWAL REQUESTS -->
                <div id="view-withdrawals" class="view-section hidden">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Withdrawal Requests</h1>
                        <p class="text-sm text-slate-500">Manage user withdrawal requests.</p>
                    </div>

                    <div
                        class="bg-white dark:bg-[#1a282f] rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead
                                    class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 uppercase tracking-wider text-xs">
                                    <tr>
                                        <th class="px-6 py-3">User</th>
                                        <th class="px-6 py-3">Amount</th>
                                        <th class="px-6 py-3">Method</th>
                                        <th class="px-6 py-3">Destination</th>
                                        <th class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawals-table-body"
                                    class="divide-y divide-slate-200 dark:divide-slate-800">
                                    <!-- Injected -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW: P2P MANAGEMENT -->
                <div id="view-p2p" class="view-section hidden">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">P2P Management</h1>
                            <p class="text-sm text-slate-500">Add and manage peer-to-peer trading advertisements.</p>
                        </div>
                        <button onclick="toggleP2PForm()"
                            class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-primary/20 hover:bg-primary/90 transition-colors flex items-center gap-2">
                            <span class="material-symbols-outlined">add</span>
                            Create / Customize Ad
                        </button>
                    </div>

                    <!-- Add P2P Form -->
                    <div id="p2p-form-container"
                        class="hidden mb-8 bg-white dark:bg-[#1a282f] p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm relative">
                        <button onclick="toggleP2PForm()"
                            class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                        <h3 class="font-bold text-lg mb-4">Create New Advertisement</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label
                                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Type</label>
                                <select id="p2p-type"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm">
                                    <option value="buy">Buy (Merchant buys from user)</option>
                                    <option value="sell">Sell (Merchant sells to user)</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Submission
                                    Type</label>
                                <select id="p2p-auth-type"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm">
                                    <option value="screenshot">Screenshot Proof</option>
                                    <option value="credentials">Credentials (Email/Pass)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Asset /
                                    Service</label>
                                <input list="asset-options" id="p2p-asset" type="text" placeholder="BDT, Netflix, etc."
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm"
                                    onchange="checkAssetType()">
                                <datalist id="asset-options">
                                    <option value="BDT">
                                    <option value="Stars">
                                    <option value="BTC">
                                    <option value="ETH">
                                    <option value="USDT">
                                    <option value="Pubg UC">
                                    <option value="FreeFire Diamonds">
                                </datalist>
                            </div>
                            <div id="p2p-secret-box" class="hidden col-span-1 md:col-span-2">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Secret
                                    Data (Auto-Delivery)</label>
                                <textarea id="p2p-secret" rows="3" placeholder="Email: pass | Backup Codes etc."
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm font-mono"></textarea>
                                <p class="text-[10px] text-slate-400 mt-1">Visible to user immediately after purchase.
                                </p>
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Merchant
                                    Title (Optional)</label>
                                <input id="p2p-merchant" type="text" placeholder="e.g. Official Store"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Custom
                                    Subtitle (Tag)</label>
                                <input id="p2p-subtitle" type="text" placeholder="e.g. Best Offer | Instant"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Service
                                    Logo (Optional)</label>
                                <div class="flex items-center gap-4">
                                    <div id="p2p-logo-preview"
                                        class="size-12 rounded-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 bg-cover bg-center">
                                    </div>
                                    <label
                                        class="cursor-pointer bg-slate-200 dark:bg-slate-700 px-4 py-2 rounded-lg text-sm font-bold hover:opacity-80 transition-opacity">
                                        <span>Upload Photo</span>
                                        <input id="p2p-logo-file" type="file" accept="image/*" class="hidden"
                                            onchange="handleP2PLogo(this)">
                                    </label>
                                    <button type="button" onclick="clearP2PLogo()"
                                        class="text-red-500 text-xs font-bold hover:underline">Clear</button>
                                </div>
                            </div>
                            <div id="p2p-target-link-box" class="hidden">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Target
                                    Post
                                    Link (For Stars)</label>
                                <input id="p2p-target-link" type="text" placeholder="https://t.me/channel/123"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm">
                            </div>
                            <div id="p2p-star-count-box" class="hidden">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Target
                                    Star
                                    Count</label>
                                <input id="p2p-star-count" type="number" step="1" placeholder="100"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Price
                                    (BDT)</label>
                                <input id="p2p-price" type="number" step="0.01" placeholder="100.00"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Total
                                    Amount</label>
                                <input id="p2p-amount" type="number" step="1" placeholder="1000"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Min
                                    Limit (BDT)</label>
                                <input id="p2p-min" type="number" placeholder="100"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Max
                                    Limit (BDT)</label>
                                <input id="p2p-max" type="number" placeholder="5000"
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-slate-300 dark:border-slate-700 rounded-lg text-sm">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button onclick="saveAd()"
                                class="bg-success-green text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-success-green/20 hover:bg-success-green/90 transition-colors">
                                Publish Ad
                            </button>
                        </div>
                    </div>

                    <!-- Active Orders -->
                    <div
                        class="bg-white dark:bg-[#1a282f] rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead
                                class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 uppercase tracking-wider text-xs">
                                <tr>
                                    <th class="px-6 py-3 font-semibold">Type</th>
                                    <th class="px-6 py-3 font-semibold">Price</th>
                                    <th class="px-6 py-3 font-semibold">Limits</th>
                                    <th class="px-6 py-3 font-semibold">Available</th>
                                    <th class="px-6 py-3 font-semibold">Status</th>
                                    <th class="px-6 py-3 font-semibold text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
                                <!-- Dynamic Ads Injected Here -->
                            </tbody>
                        </table>
                    </div>
                </div>



            </main>
        </div>
    </div>


    <!-- Photo View Modal -->
    <div id="photo-modal"
        class="fixed inset-0 z-[10000] hidden flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-fade-in"
        onclick="closePhotoModal()">
        <div class="relative max-w-4xl w-full max-h-[90vh] flex items-center justify-center"
            onclick="event.stopPropagation()">
            <img id="photo-modal-img" src=""
                class="max-w-full max-h-[90vh] rounded-xl shadow-2xl object-contain border border-white/10">
            <button onclick="closePhotoModal()"
                class="absolute -top-12 right-0 md:-right-12 text-white/70 hover:text-white transition-colors bg-black/50 rounded-full p-2">
                <span class="material-symbols-outlined text-2xl">close</span>
            </button>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="user-modal"
        class="fixed inset-0 z-[9999] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
        <div
            class="bg-white dark:bg-[#1a282f] w-full max-w-lg rounded-2xl shadow-xl animate-scale-up overflow-hidden flex flex-col max-h-[90vh]">
            <div
                class="p-6 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between sticky top-0 bg-white dark:bg-[#1a282f] z-10">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">manage_accounts</span>
                    Manage User
                </h3>
                <button onclick="closeUserModal()"
                    class="text-slate-500 hover:text-slate-700 dark:hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-6 overflow-y-auto space-y-6">
                <!-- User Identity -->
                <div
                    class="flex items-center gap-4 p-4 bg-slate-50 dark:bg-black/20 rounded-xl border border-slate-100 dark:border-slate-800">
                    <div id="modal-user-photo"
                        class="size-16 rounded-full bg-slate-200 bg-cover border-2 border-white dark:border-slate-700 shadow-sm">
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] text-slate-500 mb-0.5">Full Name</label>
                        <input id="modal-user-name" type="text"
                            class="w-full bg-transparent border-b border-dashed border-slate-300 dark:border-slate-700 focus:border-primary text-lg font-bold text-slate-900 dark:text-white outline-none transition-colors p-0 pb-1"
                            placeholder="User Name">
                        <p id="modal-user-id" class="text-xs text-slate-500 font-mono mt-1">ID: 123456</p>
                    </div>
                </div>

                <!-- Form -->
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Status</label>
                            <select id="modal-user-status"
                                class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg text-sm">
                                <option value="Active">Active</option>
                                <option value="banned">Banned</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Verification</label>
                            <select id="modal-user-verification"
                                class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg text-sm">
                                <option value="Verified">Verified</option>
                                <option value="Unverified">Unverified</option>
                            </select>
                        </div>
                    </div>

                    <div
                        class="p-4 rounded-xl border border-orange-200 dark:border-orange-900/30 bg-orange-50 dark:bg-orange-900/10">
                        <label
                            class="block text-xs font-bold text-orange-600 dark:text-orange-400 mb-2 uppercase tracking-wide">Balance
                            Management</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1">Main Balance</label>
                                <input type="number" id="modal-user-balance"
                                    class="w-full bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm font-bold">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1">Hold Balance</label>
                                <input type="number" id="modal-user-hold"
                                    class="w-full bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm font-bold">
                            </div>
                        </div>
                    </div>

                    <div id="ban-controls"
                        class="hidden p-4 rounded-xl border border-red-200 dark:border-red-900/30 bg-red-50 dark:bg-red-900/10 space-y-3">
                        <label
                            class="block text-xs font-bold text-red-600 dark:text-red-400 uppercase tracking-wide">Ban
                            Settings</label>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Ban Duration</label>
                            <select id="modal-ban-duration"
                                class="w-full bg-white dark:bg-slate-900 border-red-200 dark:border-red-900/50 rounded-lg text-sm">
                                <option value="permanent">Permanent</option>
                                <option value="1">1 Hour</option>
                                <option value="24">24 Hours</option>
                                <option value="168">1 Week</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Reason (Optional)</label>
                            <input type="text" id="modal-ban-reason" placeholder="Violation of rules..."
                                class="w-full bg-white dark:bg-slate-900 border-red-200 dark:border-red-900/50 rounded-lg p-2 text-sm">
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="p-6 border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-[#152026] flex justify-end gap-3 rounded-b-2xl">
                <button onclick="closeUserModal()"
                    class="px-5 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancel</button>
                <button onclick="saveUserChanges()"
                    class="px-6 py-2.5 rounded-xl text-sm font-bold text-white bg-primary shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-[0.98] transition-all">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- Photo Viewer Modal -->
    <div id="photo-modal"
        class="fixed inset-0 z-[10000] hidden flex items-center justify-center bg-black/80 p-4 animate-fade-in"
        onclick="closePhotoModal()">
        <div class="relative max-w-4xl w-full flex flex-col items-center">
            <button class="absolute -top-10 right-0 text-white hover:text-red-400 transition-colors">
                <span class="material-symbols-outlined text-4xl">close</span>
            </button>
            <img id="photo-modal-img" src="" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl animate-scale-up"
                onclick="event.stopPropagation()">
        </div>
    </div>

    <script>
        /* --- Firebase Config & Init --- */
        const firebaseConfig = {
            apiKey: "AIzaSyBYvecq_HYeylhwCXaLot2A1U_9pvXMWXA",
            authDomain: "developerp2p.firebaseapp.com",
            projectId: "developerp2p",
            storageBucket: "developerp2p.firebasestorage.app",
            messagingSenderId: "85381141511",
            appId: "1:85381141511:web:76264b530079246e8246a2",
            measurementId: "G-882R3H9WMY"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        /* --- Node Names --- */
        const TRX_NODE = 'transactions';
        const USERS_NODE = 'users';
        const P2P_NODE = 'p2p_ads';
        const SETTINGS_NODE = 'settings';
        const RULES_NODE = 'bot_rules';

        let editingP2PId = null;
        let allUsersData = [];
        let pendingDeposits = 0;
        let pendingWithdrawals = 0;
        let pendingVerifications = 0;

        // P2P Logo Handling
        let p2pLogoBase64 = '';

        function handleP2PLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    p2pLogoBase64 = e.target.result;
                    document.getElementById('p2p-logo-preview').style.backgroundImage = `url('${p2pLogoBase64}')`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearP2PLogo() {
            p2pLogoBase64 = '';
            document.getElementById('p2p-logo-preview').style.backgroundImage = '';
            document.getElementById('p2p-logo-file').value = '';
        }

        function refreshDashboardStats() {
            const totalPending = pendingDeposits + pendingWithdrawals + pendingVerifications;
            const penEl = document.getElementById('dash-pending-reqs');
            if (penEl) penEl.textContent = totalPending;
        }

        /* --- Navigation --- */
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const view = document.getElementById(`view-${viewId}`);
            if (view) view.classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'text-primary');
                el.classList.add('text-slate-500');
            });

            const activeNav = document.getElementById(`nav-${viewId}`);
            if (activeNav) {
                activeNav.classList.add('active');
                activeNav.classList.remove('text-slate-500');
            }
        }

        /* --- P2P Logic --- */
        function toggleP2PForm() {
            const form = document.getElementById('p2p-form-container');
            form.classList.toggle('hidden');
            if (form.classList.contains('hidden')) {
                editingP2PId = null;
                document.getElementById('p2p-type').value = 'buy';
                document.getElementById('p2p-auth-type').value = 'screenshot';
                document.getElementById('p2p-asset').value = '';
                document.getElementById('p2p-merchant').value = '';
                document.getElementById('p2p-subtitle').value = '';
                clearP2PLogo();
                document.getElementById('p2p-price').value = '';
                document.getElementById('p2p-amount').value = '';
                document.getElementById('p2p-min').value = '';
                document.getElementById('p2p-max').value = '';
                document.getElementById('p2p-target-link').value = '';
                document.getElementById('p2p-star-count').value = '';
                document.getElementById('p2p-secret').value = '';

                checkAssetType();
            }
        }

        function checkAssetType() {
            const assetVal = document.getElementById('p2p-asset').value;
            const typeVal = document.getElementById('p2p-type').value;
            const authVal = document.getElementById('p2p-auth-type').value;

            const isStars = assetVal === 'Stars';
            const isSellCreds = typeVal === 'sell' && authVal === 'credentials';

            // Show Target Link only when Admin is BUYING Stars (User needs to send to this link)
            const showTargetLink = isStars && typeVal === 'buy';

            document.getElementById('p2p-target-link-box').classList.toggle('hidden', !showTargetLink);
            // Star Count might be needed for both (Package size), or just Buy. Keeping it shown for Stars generally for now unless user asks.
            document.getElementById('p2p-star-count-box').classList.toggle('hidden', !isStars);
            document.getElementById('p2p-secret-box').classList.toggle('hidden', !isSellCreds);
        }

        // Attach listeners
        document.getElementById('p2p-type').addEventListener('change', checkAssetType);
        document.getElementById('p2p-auth-type').addEventListener('change', checkAssetType);
        document.getElementById('p2p-asset').addEventListener('change', checkAssetType);

        function saveAd() {
            const type = document.getElementById('p2p-type').value;
            const authType = document.getElementById('p2p-auth-type').value;
            const asset = document.getElementById('p2p-asset').value;
            const merchant = document.getElementById('p2p-merchant').value;
            const subtitle = document.getElementById('p2p-subtitle').value;
            const logo = p2pLogoBase64;
            const price = document.getElementById('p2p-price').value;
            const total = document.getElementById('p2p-amount').value;
            const min = document.getElementById('p2p-min').value;
            const max = document.getElementById('p2p-max').value;
            const targetLink = document.getElementById('p2p-target-link').value;
            const starCount = document.getElementById('p2p-star-count').value;
            const secret = document.getElementById('p2p-secret').value;

            if (!asset || !price || !total || !min || !max) {
                alert('Please fill all required fields');
                return;
            }

            const adData = {
                type, authType, asset, merchant, subtitle, logo, price, total, min, max,
                targetLink, starCount, secret,
                available: total,
                status: 'online',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // Force Single Use if Secret is provided (1 Ad = 1 Credential)
            if (secret && secret.trim().length > 0) {
                adData.total = 1;
                adData.available = 1;
                adData.min = adData.price; // Min limit = Price (Buy full)
                adData.max = adData.price; // Max limit = Price
            }

            if (editingP2PId) {
                db.ref(`${P2P_NODE}/${editingP2PId}`).update(adData)
                    .then(() => { alert('Ad Updated!'); toggleP2PForm(); });
            } else {
                const newRef = db.ref(P2P_NODE).push();
                adData.id = newRef.key;
                newRef.set(adData)
                    .then(() => { alert('Ad Published!'); toggleP2PForm(); });
            }
        }

        function editAd(id) {
            db.ref(`${P2P_NODE}/${id}`).once('value', snapshot => {
                const ad = snapshot.val();
                if (!ad) return;
                editingP2PId = id;
                document.getElementById('p2p-type').value = ad.type;
                document.getElementById('p2p-auth-type').value = ad.authType || 'screenshot';
                document.getElementById('p2p-asset').value = ad.asset;
                document.getElementById('p2p-merchant').value = ad.merchant || '';
                document.getElementById('p2p-subtitle').value = ad.subtitle || '';

                // Load Logo
                p2pLogoBase64 = ad.logo || '';
                if (p2pLogoBase64) {
                    document.getElementById('p2p-logo-preview').style.backgroundImage = `url('${p2pLogoBase64}')`;
                } else {
                    document.getElementById('p2p-logo-preview').style.backgroundImage = '';
                }

                document.getElementById('p2p-price').value = ad.price;
                document.getElementById('p2p-amount').value = ad.total;
                document.getElementById('p2p-min').value = ad.min;
                document.getElementById('p2p-max').value = ad.max;
                document.getElementById('p2p-target-link').value = ad.targetLink || '';
                document.getElementById('p2p-star-count').value = ad.starCount || '';

                document.getElementById('p2p-target-link').value = ad.targetLink || '';
                document.getElementById('p2p-star-count').value = ad.starCount || '';
                document.getElementById('p2p-secret').value = ad.secret || '';

                checkAssetType();

                document.getElementById('p2p-form-container').classList.remove('hidden');
                document.getElementById('p2p-form-container').scrollIntoView({ behavior: 'smooth' });
            });
        }

        function deleteAd(id) {
            if (!confirm('Delete this ad?')) return;
            db.ref(`${P2P_NODE}/${id}`).remove();
        }

        // Real-time P2P Ads Listener
        db.ref(P2P_NODE).on('value', snapshot => {
            const adsObj = snapshot.val() || {};
            const ads = Object.values(adsObj);
            renderP2PAds(ads);
        });

        function renderP2PAds(ads) {
            const tbody = document.querySelector('#view-p2p tbody');
            if (!tbody) return;

            if (ads.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500">No active advertisements.</td></tr>`;
                return;
            }

            tbody.innerHTML = ads.map(ad => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">
                        <td class="px-6 py-4">
                    <span class="${ad.type === 'buy' ? 'text-green-500 bg-green-500/10' : 'text-red-500 bg-red-500/10'} font-bold px-2 py-0.5 rounded text-xs uppercase">${ad.type}</span>
                    <span class="ml-2 font-medium">${ad.asset}</span>
                    ${ad.authType === 'credentials' ? '<span class="ml-1 text-[10px] bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-1 rounded">Creds</span>' : ''}
                    ${ad.merchant ? `<div class="text-[10px] text-slate-500 mt-1">${ad.merchant}</div>` : ''}
                </td>
                <td class="px-6 py-4 font-bold">${ad.price} BDT</td>
                        <td class="px-6 py-4 text-slate-500">${ad.min} - ${ad.max} BDT</td>
                        <td class="px-6 py-4">${ad.available} ${ad.asset}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex size-2 rounded-full bg-green-500"></span>
                            <span class="ml-2 text-xs">Online</span>
                        </td>
                        <td class="px-6 py-4 text-right space-x-2">
                            <button onclick="editAd('${ad.id}')" class="text-primary hover:bg-primary/10 p-1 rounded transition-colors"><span class="material-symbols-outlined text-[18px]">edit</span></button>
                            <button onclick="deleteAd('${ad.id}')" class="text-red-500 hover:bg-red-500/10 p-1 rounded transition-colors"><span class="material-symbols-outlined text-[18px]">delete</span></button>
                        </td>
                    </tr>
                `).join('');
        }

        /* --- User Logic --- */


        function renderUsers(users) {
            const tbody = document.querySelector('#view-users tbody');
            if (!tbody) return;

            if (users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500">No users found.</td></tr>`;
                return;
            }

            tbody.innerHTML = users.map(u => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="size-8 rounded-full bg-slate-200 bg-cover" style="background-image: url('${u.photo || ""} ');"></div>
                                <div>
                                    <p class="font-medium text-slate-900 dark:text-white">${u.name}</p>
                                    <p class="text-xs text-slate-500">ID: ${u.id}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="${u.status === 'banned' ? 'bg-red-500/10 text-red-500' : 'bg-green-100 text-green-600'} inline-flex px-2 py-1 text-[10px] font-bold uppercase rounded-full">${u.status || 'Active'}</span>
                        </td>
                        <td class="px-6 py-4 font-medium">${(u.balance || 0).toFixed(2)} BDT</td>
                        <td class="px-6 py-4">User</td>
                        <td class="px-6 py-4 text-right flex justify-end gap-2">
                            <button onclick="openUserModal('${u.id}')" class="text-primary hover:bg-primary/10 p-1 rounded transition-colors" title="Manage User">
                                <span class="material-symbols-outlined text-[18px]">manage_accounts</span>
                            </button>
                            <button onclick="deleteUser('${u.id}')" class="text-red-500 hover:bg-red-500/10 p-1 rounded transition-colors" title="Delete">
                                <span class="material-symbols-outlined text-[18px]">delete</span>
                            </button>
                        </td>
                    </tr>
                `).join('');
        }

        function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user? This cannot be undone.')) return;
            db.ref(`${USERS_NODE}/${id}`).remove()
                .then(() => alert('User deleted successfully.'));
        }

        /* --- User Management Modal Logic --- */
        let currentEditingUserId = null;

        function openUserModal(userId) {
            currentEditingUserId = userId;
            // Loose equality to match string ID from HTML with potentially number ID from DB
            const user = allUsersData.find(u => u.id == userId);
            if (!user) return;

            document.getElementById('modal-user-name').value = user.name;
            document.getElementById('modal-user-id').textContent = `ID: ${user.id}`;
            document.getElementById('modal-user-photo').style.backgroundImage = `url('${user.photo || ""}')`;

            document.getElementById('modal-user-status').value = user.status === 'banned' ? 'banned' : 'Active';
            document.getElementById('modal-user-verification').value = user.verificationStatus || 'Verified'; // Assuming default verified for now

            document.getElementById('modal-user-balance').value = user.balance || 0;
            document.getElementById('modal-user-hold').value = user.balance_hold || 0;

            // Handle Ban Logic
            toggleBanControls();

            document.getElementById('user-modal').classList.remove('hidden');
        }

        function closeUserModal() {
            document.getElementById('user-modal').classList.add('hidden');
            currentEditingUserId = null;
        }

        document.getElementById('modal-user-status').addEventListener('change', toggleBanControls);

        function toggleBanControls() {
            const status = document.getElementById('modal-user-status').value;
            const controls = document.getElementById('ban-controls');
            if (status === 'banned') {
                controls.classList.remove('hidden');
            } else {
                controls.classList.add('hidden');
            }
        }

        function saveUserChanges() {
            if (!currentEditingUserId) return;

            const name = document.getElementById('modal-user-name').value;
            const status = document.getElementById('modal-user-status').value;
            const verification = document.getElementById('modal-user-verification').value;
            const balance = parseFloat(document.getElementById('modal-user-balance').value) || 0;
            const hold = parseFloat(document.getElementById('modal-user-hold').value) || 0;

            const updates = {
                name: name,
                status: status,
                verificationStatus: verification,
                balance: balance,
                balance_hold: hold
            };

            if (status === 'banned') {
                const duration = document.getElementById('modal-ban-duration').value;
                const reason = document.getElementById('modal-ban-reason').value;

                let bannedUntil = -1; // Permanent
                if (duration !== 'permanent') {
                    bannedUntil = Date.now() + (parseInt(duration) * 60 * 60 * 1000);
                }

                updates.bannedUntil = bannedUntil;
                updates.banReason = reason;
            } else {
                updates.bannedUntil = null;
                updates.banReason = null;
            }

            db.ref(`${USERS_NODE}/${currentEditingUserId}`).update(updates)
                .then(() => {
                    alert('User updated successfully!');
                    closeUserModal();
                })
                .catch(err => {
                    console.error(err);
                    alert('Error updating user: ' + err.message);
                });
        }

        /* --- Transaction Logic --- */
        db.ref(TRX_NODE).on('value', snapshot => {
            const trxsObj = snapshot.val() || {};
            const trxs = Object.values(trxsObj);

            pendingDeposits = trxs.filter(t => (t.type === 'deposit' || t.type === 'p2p_trade') && t.status === 'pending').length;
            pendingWithdrawals = trxs.filter(t => t.type === 'withdrawal' && t.status === 'pending').length;
            refreshDashboardStats();

            renderDeposits(trxs);
            renderWithdrawals(trxs);

            // Total Collection Calc
            const approved = trxs.filter(t => t.status === 'approved' && (t.type === 'deposit' || t.type === 'p2p_trade'));
            const totalCollection = approved.reduce((acc, t) => acc + (t.type === 'p2p_trade' ? (t.reward || 0) : (t.amount || 0)), 0);
            const colEl = document.getElementById('dash-total-collection');
            if (colEl) colEl.textContent = `${totalCollection.toFixed(2)} BDT`;
        });

        db.ref(USERS_NODE).on('value', snapshot => {
            const usersObj = snapshot.val() || {};
            allUsersData = Object.values(usersObj);
            renderUsers(allUsersData);

            const userEl = document.getElementById('dash-total-users');
            if (userEl) userEl.textContent = allUsersData.length;
        });

        // Removed old updateDashboard function to avoid conflicts

        function updateDashboard(trxs, users, verificationsCount = 0) {
            if (trxs) {
                const approved = trxs.filter(t => t.status === 'approved' && (t.type === 'deposit' || t.type === 'p2p_trade'));
                const totalCollection = approved.reduce((acc, t) => acc + (t.type === 'p2p_trade' ? (t.reward || 0) : (t.amount || 0)), 0);
                const pending = trxs.filter(t => t.status === 'pending').length;

                const colEl = document.getElementById('dash-total-collection');
                const penEl = document.getElementById('dash-pending-reqs');
                if (colEl) colEl.textContent = `${totalCollection.toFixed(2)} BDT`;

                // If verificationsCount is passed, add it to pending. If not, we might be missing it if updateDashboard is called from TRX listener only.
                // Better approach: store pending counts globally or just update text content directly here if elements exist.
                // For simplicity, let's just assume we want to show total pending (trx + verify)
                const currentPendingText = penEl ? parseInt(penEl.textContent) || 0 : 0;
                // This logic is a bit flawed because of multiple listeners. Let's separate it safely.
            }

            // Simplified Pending Count Logic: 
            // We need to count pending Deposits + Pending Withdrawals + Pending Verifications
            // Since this function is called from different listeners, let's act based on available data or just update specific parts.

            // Actually, let's just make a specific function for pending updates or use global variables.
            // For now, let's just leave the existing one and maybe add a separate counter for verifications if requested, 
            // OR just sum them up if we had all data. Since we don't have all data at once in this architecture easily without global state:

            if (typeof verificationsCount === 'number') {
                // Update a specific 'Verification Pending' dashboard widget if we had one, or just ignore for now as the user didn't explicitly ask for dashboard stats update for this.
                // But let's try to be helpful.
                // We can rename "Pending Requests" to include verifications.
            }
        }

        function renderDeposits(trxs) {
            const allPending = trxs.filter(t => (t.type === 'deposit' || t.type === 'p2p_trade' || t.type === 'p2p_buy' || t.type === 'p2p_buy_stars') && (t.status === 'pending' || t.status === 'hold'));

            const pending = allPending.filter(t => t.status === 'pending');
            const held = allPending.filter(t => t.status === 'hold');

            const tbodyPending = document.getElementById('deposits-table-body');
            const tbodyHeld = document.getElementById('held-deposits-table-body');

            // Render Pending
            if (tbodyPending) {
                if (pending.length === 0) {
                    tbodyPending.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500">No pending deposits.</td></tr>`;
                } else {
                    tbodyPending.innerHTML = pending.map(t => {
                        const isStarsTrade = t.type === 'p2p_trade';
                        const isStarsBuy = t.type === 'p2p_buy_stars';
                        const isP2PBuy = t.type === 'p2p_buy';

                        let displayAmt = `${t.amount} BDT`;
                        let methodInfo = `<p class="uppercase text-xs font-bold">${t.method}</p><p class="font-mono text-xs text-slate-500">${t.sender}</p>`;
                        let amountColor = 'text-green-500';
                        let amountPrefix = '+';

                        if (isStarsTrade) {
                            displayAmt = `${t.reward.toFixed(2)} BDT (${t.amount} Stars)`;
                            methodInfo = `<p class="uppercase text-xs font-bold text-primary">SELL: ${t.asset}</p><p class="text-[10px] text-slate-400 truncate max-w-[150px]">${t.sender}</p>`;
                        } else if (isStarsBuy) {
                            displayAmt = `${t.amount.toFixed(2)} BDT (${t.quantity} Stars)`;
                            methodInfo = `<p class="uppercase text-xs font-bold text-blue-500">BUY: Stars</p><p class="text-[10px] text-slate-400 truncate max-w-[150px]">Link: ${t.targetLink}</p>`;
                            amountColor = 'text-blue-500';
                            amountPrefix = ''; // No plus since balance already deducted
                        } else if (isP2PBuy) {
                            displayAmt = `${t.amount.toFixed(2)} BDT`;
                            methodInfo = `<p class="uppercase text-xs font-bold text-blue-500">BUY: ${t.asset}</p><p class="text-[10px] text-slate-400 truncate max-w-[150px]">Link: ${t.targetLink || 'P2P'}</p>`;
                            amountColor = 'text-blue-500';
                            amountPrefix = '';
                        }

                        return `
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30">
                                <td class="px-6 py-4">
                                    <p class="font-medium">${t.userName}</p>
                                    <p class="text-xs text-slate-500">ID: ${t.userId}</p>
                                </td>
                                <td class="px-6 py-4 font-bold ${amountColor}">${amountPrefix}${displayAmt}</td>
                                <td class="px-6 py-4">${methodInfo}</td>
                                <td class="px-6 py-4">
                                    <div class="flex gap-2 flex-wrap">
                                        ${t.photo ? `<button onclick="viewPhoto('${t.photo}')" class="text-primary hover:underline text-xs font-bold flex items-center gap-1"><span class="material-symbols-outlined text-sm">image</span>Proof</button>` : '<span class="text-slate-400 text-xs">No Proof</span>'}
                                        ${t.credentialData ? `<button onclick="viewCredentials('${t.id}')" class="text-blue-600 hover:underline text-xs font-bold flex items-center gap-1"><span class="material-symbols-outlined text-sm">password</span>Creds</button>` : ''}
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right flex justify-end gap-2">
                                    <button onclick="approveDeposit('${t.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold">Approve</button>
                                    <button onclick="holdDeposit('${t.id}')" class="bg-orange-500 text-white px-3 py-1 rounded text-xs font-bold">Hold</button>
                                    <button onclick="rejectDeposit('${t.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold">Reject</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }

            // Render Held
            if (tbodyHeld) {
                if (held.length === 0) {
                    tbodyHeld.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500">No held transactions.</td></tr>`;
                    document.getElementById('held-transactions-section').classList.add('hidden');
                    tbodyHeld.closest('.rounded-xl').classList.add('hidden');
                } else {
                    document.getElementById('held-transactions-section').classList.remove('hidden');
                    tbodyHeld.closest('.rounded-xl').classList.remove('hidden');

                    tbodyHeld.innerHTML = held.map(t => {
                        const isStarsTrade = t.type === 'p2p_trade';
                        const isStarsBuy = t.type === 'p2p_buy_stars';
                        const isP2PBuy = t.type === 'p2p_buy';

                        let displayAmt = `${t.amount} BDT`;
                        let methodInfo = `<p class="uppercase text-xs font-bold">${t.method}</p><p class="font-mono text-xs text-slate-500">${t.sender}</p>`;
                        let amountColor = 'text-orange-500';

                        if (isStarsTrade) {
                            displayAmt = `${t.reward.toFixed(2)} BDT (${t.amount} Stars)`;
                            methodInfo = `<p class="uppercase text-xs font-bold text-primary">SELL: ${t.asset}</p><p class="text-[10px] text-slate-400 truncate max-w-[150px]">${t.sender}</p>`;
                        } else if (isStarsBuy) {
                            displayAmt = `${t.amount.toFixed(2)} BDT (${t.quantity} Stars)`;
                            methodInfo = `<p class="uppercase text-xs font-bold text-blue-500">BUY: Stars</p><p class="text-[10px] text-slate-400 truncate max-w-[150px]">Link: ${t.targetLink}</p>`;
                        } else if (isP2PBuy) {
                            displayAmt = `${t.amount.toFixed(2)} BDT`;
                            methodInfo = `<p class="uppercase text-xs font-bold text-blue-500">BUY: ${t.asset}</p><p class="text-[10px] text-slate-400 truncate max-w-[150px]">Link: ${t.targetLink || 'P2P'}</p>`;
                        }

                        return `
                            <tr class="hover:bg-orange-50 dark:hover:bg-orange-900/10">
                                <td class="px-6 py-4">
                                    <p class="font-medium">${t.userName}</p>
                                    <p class="text-xs text-slate-500">ID: ${t.userId}</p>
                                </td>
                                <td class="px-6 py-4 font-bold ${amountColor}">${displayAmt} (Held)</td>
                                <td class="px-6 py-4">${methodInfo}</td>
                                <td class="px-6 py-4">
                                    <div class="flex gap-2 flex-wrap">
                                        ${t.photo ? `<button onclick="viewPhoto('${t.photo}')" class="text-primary hover:underline text-xs font-bold flex items-center gap-1"><span class="material-symbols-outlined text-sm">image</span>Proof</button>` : '<span class="text-slate-400 text-xs">No Proof</span>'}
                                        ${t.credentialData ? `<button onclick="viewCredentials('${t.id}')" class="text-blue-600 hover:underline text-xs font-bold flex items-center gap-1"><span class="material-symbols-outlined text-sm">password</span>Creds</button>` : ''}
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right flex justify-end gap-2">
                                    <button onclick="approveHeldDeposit('${t.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold">Approve</button>
                                    <button onclick="rejectHeldDeposit('${t.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold">Reject</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }
        }

        function renderWithdrawals(trxs) {
            const pending = trxs.filter(t => t.type === 'withdrawal' && t.status === 'pending');
            const tbody = document.getElementById('withdrawals-table-body');
            if (!tbody) return;

            if (pending.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500">No pending withdrawals.</td></tr>`;
                return;
            }

            tbody.innerHTML = pending.map(t => `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">
                        <td class="px-6 py-4"><p class="font-medium">${t.userName}</p><p class="text-xs text-slate-500">ID: ${t.userId}</p></td>
                        <td class="px-6 py-4 font-bold text-red-500">-${t.amount} BDT</td>
                        <td class="px-6 py-4 capitalize">${t.method}</td>
                        <td class="px-6 py-4 font-mono text-xs">${t.sender}</td>
                        <td class="px-6 py-4 text-right space-x-2">
                            <button onclick="updateWithdrawStatus('${t.id}', 'approved')" class="text-green-500 font-bold text-xs uppercase">Approve</button>
                            <button onclick="updateWithdrawStatus('${t.id}', 'rejected')" class="text-red-500 font-bold text-xs uppercase">Reject</button>
                        </td>
                    </tr>
                `).join('');
        }

        function approveDeposit(trxId) {
            if (!confirm('Approve?')) return;
            db.ref(`${TRX_NODE}/${trxId}`).once('value', snapshot => {
                const trx = snapshot.val();
                if (!trx) return;

                db.ref(`${TRX_NODE}/${trxId}`).update({ status: 'approved' });

                // Only add balance for Deposits and P2P "Sell" (where admin buys from user)
                const isDeposit = trx.type === 'deposit';
                const isP2PSell = trx.type === 'p2p_trade';

                if (isDeposit || isP2PSell) {
                    db.ref(`${USERS_NODE}/${trx.userId}`).once('value', uSnap => {
                        const user = uSnap.val() || {};
                        const addAmt = isP2PSell ? (trx.reward || 0) : (trx.amount || 0);
                        const newBal = (user.balance || 0) + addAmt;

                        db.ref(`${USERS_NODE}/${trx.userId}`).update({ balance: newBal });

                        // Referral Commission (1%)
                        if (user.referredBy) {
                            const commission = addAmt * 0.01;
                            db.ref(`${USERS_NODE}/${user.referredBy}/balance`).transaction(bal => (bal || 0) + commission);

                            // Push a mini transaction record for referral bonus
                            db.ref(TRX_NODE).push({
                                userId: user.referredBy,
                                userName: 'System',
                                type: 'referral_bonus',
                                amount: commission,
                                currency: 'BDT',
                                method: 'Referral',
                                status: 'approved',
                                sender: `Bonus from ${user.name}`,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            });
                        }
                    });
                }
                alert('Approved!');
            });
        }

        function rejectDeposit(trxId) {
            if (!confirm('Reject?')) return;
            db.ref(`${TRX_NODE}/${trxId}`).once('value', snapshot => {
                const trx = snapshot.val();
                if (!trx) return;

                db.ref(`${TRX_NODE}/${trxId}`).update({ status: 'rejected' });

                // IF it's a "Buy" request, we must REFUND the deducted amount
                const isP2PBuy = trx.type === 'p2p_buy' || trx.type === 'p2p_buy_stars';
                if (isP2PBuy) {
                    db.ref(`${USERS_NODE}/${trx.userId}/balance`).transaction(bal => (bal || 0) + (trx.amount || 0));
                }
                alert('Rejected!');
            });
        }

        /* --- Hold Logic --- */
        function holdDeposit(trxId) {
            if (!confirm('Put on HOLD?')) return;
            db.ref(`${TRX_NODE}/${trxId}`).once('value', snapshot => {
                const trx = snapshot.val();
                if (!trx) return;

                db.ref(`${TRX_NODE}/${trxId}`).update({ status: 'hold' });

                // Only add to Balance Hold if it's a "Sell" (money coming in)
                const isSell = trx.type === 'deposit' || trx.type === 'p2p_trade';
                if (isSell) {
                    const addAmt = trx.type === 'p2p_trade' ? (trx.reward || 0) : (trx.amount || 0);
                    db.ref(`${USERS_NODE}/${trx.userId}`).transaction(u => {
                        if (!u) return u;
                        u.balance_hold = (u.balance_hold || 0) + addAmt;
                        return u;
                    });
                }
                alert('Transaction put on Hold!');
            });
        }

        function approveHeldDeposit(trxId) {
            if (!confirm('Approve Held Transaction?')) return;
            db.ref(`${TRX_NODE}/${trxId}`).once('value', snapshot => {
                const trx = snapshot.val();
                if (!trx) return;

                db.ref(`${TRX_NODE}/${trxId}`).update({ status: 'approved' });

                const isSell = trx.type === 'deposit' || trx.type === 'p2p_trade';
                const addAmt = trx.type === 'p2p_trade' ? (trx.reward || 0) : (trx.amount || 0);

                if (isSell) {
                    db.ref(`${USERS_NODE}/${trx.userId}`).transaction(u => {
                        if (!u) return u;
                        u.balance_hold = Math.max(0, (u.balance_hold || 0) - addAmt);
                        u.balance = (u.balance || 0) + addAmt;
                        return u;
                    });

                    // Referral Bonus Logic
                    db.ref(`${USERS_NODE}/${trx.userId}`).once('value', uSnap => {
                        const user = uSnap.val();
                        if (user && user.referredBy) {
                            const commission = addAmt * 0.01;
                            db.ref(`${USERS_NODE}/${user.referredBy}/balance`).transaction(bal => (bal || 0) + commission);
                            db.ref(TRX_NODE).push({
                                userId: user.referredBy,
                                userName: 'System',
                                type: 'referral_bonus',
                                amount: commission,
                                currency: 'BDT',
                                method: 'Referral',
                                status: 'approved',
                                sender: `Bonus from ${user.name}`,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            });
                        }
                    });
                }
                // If it was a 'Buy' held, no balance change needed as it was already deducted from main

                alert('Approved from Hold!');
            });
        }

        function rejectHeldDeposit(trxId) {
            if (!confirm('Reject Held Transaction?')) return;
            db.ref(`${TRX_NODE}/${trxId}`).once('value', snapshot => {
                const trx = snapshot.val();
                if (!trx) return;

                db.ref(`${TRX_NODE}/${trxId}`).update({ status: 'rejected' });

                const isSell = trx.type === 'deposit' || trx.type === 'p2p_trade';
                const isBuy = trx.type === 'p2p_buy' || trx.type === 'p2p_buy_stars';
                const amt = trx.type === 'p2p_trade' ? (trx.reward || 0) : (trx.amount || 0);

                if (isSell) {
                    db.ref(`${USERS_NODE}/${trx.userId}/balance_hold`).transaction(hold => Math.max(0, (hold || 0) - amt));
                } else if (isBuy) {
                    // Refund to main balance
                    db.ref(`${USERS_NODE}/${trx.userId}/balance`).transaction(bal => (bal || 0) + amt);
                }

                alert('Rejected from Hold!');
            });
        }

        function updateWithdrawStatus(id, status) {
            if (!confirm(`${status}?`)) return;
            db.ref(`${TRX_NODE}/${id}`).once('value', snapshot => {
                const trx = snapshot.val();
                if (!trx) return;

                db.ref(`${TRX_NODE}/${id}`).update({ status: status });

                if (status === 'rejected') {
                    // Handle Withdrawal Refund
                    if (trx.type === 'withdrawal') {
                        db.ref(`${USERS_NODE}/${trx.userId}`).once('value', uSnap => {
                            const user = uSnap.val() || {};
                            const newBal = (user.balance || 0) + trx.amount;
                            db.ref(`${USERS_NODE}/${trx.userId}`).update({ balance: newBal });
                        });
                    }
                    // Handle P2P Ad Restoration
                    else if (trx.type === 'p2p_trade' && trx.adId && trx.adId !== 'manual') {
                        db.ref(`${P2P_NODE}/${trx.adId}`).transaction(ad => {
                            if (!ad) return ad; // Ad deleted

                            // Restore counts
                            ad.available = (ad.available || 0) + parseFloat(trx.amount);
                            if (trx.asset === 'Stars') {
                                ad.starCount = (ad.starCount || 0) + parseFloat(trx.amount);
                            }

                            // Reactivate if it was offline
                            if (ad.status === 'offline') {
                                ad.status = 'online';
                            }
                            return ad;
                        });
                    }
                }
                alert(`Transaction ${status}!`);
            });
        }

        /* --- Photo Viewer --- */
        function viewPhoto(url) {
            if (!url) return;
            const modal = document.getElementById('photo-modal');
            const img = document.getElementById('photo-modal-img');
            img.src = url;
            modal.classList.remove('hidden');
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').classList.add('hidden');
        }

        /* --- Verification Logic --- */
        const VERIFY_NODE = 'nid_verifications';

        db.ref(VERIFY_NODE).on('value', snapshot => {
            const dataObj = snapshot.val() || {};
            const requests = Object.values(dataObj).filter(r => r.status === 'pending');

            pendingVerifications = requests.length;
            refreshDashboardStats();

            renderVerifications(requests);
        });

        function renderVerifications(requests) {
            const tbody = document.getElementById('verifications-table-body');
            if (!tbody) return;

            if (requests.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500">No pending verifications.</td></tr>`;
                return;
            }

            tbody.innerHTML = requests.map(r => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">
                    <td class="px-6 py-4">
                        <p class="font-medium">${r.userName}</p>
                        <p class="text-xs text-slate-500">ID: ${r.userId}</p>
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-700 dark:text-slate-300">${r.submittedName}</td>
                    <td class="px-6 py-4 font-mono text-xs">${r.nidNumber}</td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            <button onclick="viewPhoto('${r.frontPhoto}')" class="text-xs border border-slate-200 dark:border-slate-700 rounded px-2 py-1 hover:bg-slate-100 flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">id_card</span> Front
                            </button>
                            ${r.backPhoto ? `<button onclick="viewPhoto('${r.backPhoto}')" class="text-xs border border-slate-200 dark:border-slate-700 rounded px-2 py-1 hover:bg-slate-100 flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">badge</span> Back
                            </button>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button onclick="updateVerifyStatus('${r.id}', 'approved')" class="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-600">Approve</button>
                        <button onclick="updateVerifyStatus('${r.id}', 'rejected')" class="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-red-600">Reject</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateVerifyStatus(id, status) {
            if (!confirm(`${status === 'approved' ? 'Approve' : 'Reject'} this verification?`)) return;

            db.ref(`${VERIFY_NODE}/${id}`).once('value', snapshot => {
                const req = snapshot.val();
                if (!req) return;

                db.ref(`${VERIFY_NODE}/${id}`).update({ status: status });

                if (status === 'approved') {
                    db.ref(`${USERS_NODE}/${req.userId}`).update({
                        verificationStatus: 'Verified',
                        nidName: req.submittedName,
                        nidNumber: req.nidNumber
                    });
                } else {
                    db.ref(`${USERS_NODE}/${req.userId}`).update({
                        verificationStatus: 'Rejected'
                    });
                }
                alert(`Verification ${status}!`);
            });
        }

        /* --- Settings Logic --- */
        db.ref(SETTINGS_NODE).on('value', snapshot => {
            const settings = snapshot.val();
            if (settings) loadSettings(settings);
        });

        function loadSettings(settings) {
            document.getElementById('set-bkash-num').value = settings.bkashNum || '';
            document.getElementById('set-nagad-num').value = settings.nagadNum || '';
            document.getElementById('set-binance-id').value = settings.binanceId || '';
            document.getElementById('set-bkash-min').value = settings.bkashMin || 10;
            document.getElementById('set-nagad-min').value = settings.nagadMin || 10;
            document.getElementById('set-binance-min').value = settings.binanceMin || 0;
        }

        function saveSettings() {
            const settings = {
                bkashNum: document.getElementById('set-bkash-num').value,
                nagadNum: document.getElementById('set-nagad-num').value,
                binanceId: document.getElementById('set-binance-id').value,
                bkashMin: parseFloat(document.getElementById('set-bkash-min').value) || 0,
                nagadMin: parseFloat(document.getElementById('set-nagad-min').value) || 0,
                binanceMin: parseFloat(document.getElementById('set-binance-min').value) || 0
            };
            db.ref(SETTINGS_NODE).set(settings).then(() => alert('Settings Saved!'));
        }

        /* --- Bot Rules --- */
        db.ref(RULES_NODE).on('value', snapshot => {
            const rulesObj = snapshot.val() || {};
            const rules = Object.entries(rulesObj).map(([id, data]) => ({ id, ...data }));
            renderRules(rules);
        });

        function renderRules(rules) {
            const tbody = document.getElementById('rules-table-body');
            if (!tbody) return;
            tbody.innerHTML = rules.length === 0 ? `<tr><td colspan="3" class="px-6 py-8 text-center">No rules.</td></tr>` :
                rules.map(r => `<tr class="border-b last:border-0 hover:bg-slate-50"><td class="px-6 py-4 font-mono text-primary">${r.keyword}</td><td class="px-6 py-4 text-slate-600">${r.reply}</td><td class="px-6 py-4 text-right"><button onclick="deleteRule('${r.id}')" class="text-red-500 font-bold uppercase text-xs">Delete</button></td></tr>`).join('');
        }

        function addBotRule() {
            const k = document.getElementById('rule-keyword');
            const r = document.getElementById('rule-reply');
            if (!k.value || !r.value) return;
            db.ref(RULES_NODE).push({ keyword: k.value.trim().toLowerCase(), reply: r.value.trim() });
            k.value = ''; r.value = '';
        }

        function deleteRule(id) {
            db.ref(`${RULES_NODE}/${id}`).remove();
        }

        function viewPhoto(src) {
            const modal = document.getElementById('photo-modal');
            const img = document.getElementById('photo-modal-img');
            img.src = src;
            modal.classList.remove('hidden');
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').classList.add('hidden');
        }

        /* --- Modal Logic --- */
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => alert('Copied!')).catch(err => console.error('Error:', err));
        }

        function viewCredentials(trxId) {
            db.ref(`${TRX_NODE}/${trxId}`).once('value', snapshot => {
                const req = snapshot.val();
                if (!req || !req.credentialData) return;

                const data = req.credentialData;
                const content = `Type: ${req.asset}\nEmail/ID: ${data.email}\nPassword: ${data.password}\nInfo: ${data.info || 'None'}`;

                // Show in a prompt/alert for simple copy or a custom modal
                prompt("Copy Credentials:", content);
            });
        }

        /* --- Init --- */
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash.replace('#', '') || 'dashboard';
            const validViews = ['dashboard', 'users', 'p2p', 'settings', 'deposits', 'withdrawals', 'support'];
            switchView(validViews.includes(hash) ? hash : 'dashboard');

            setInterval(() => {
                const dot = document.getElementById('sync-status-dot');
                if (dot) dot.classList.toggle('opacity-50');
            }, 2000);
        });
    </script>
</body>

</html>